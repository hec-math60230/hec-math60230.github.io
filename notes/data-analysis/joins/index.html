<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>16&nbsp; Joins and Merges – Empirical Finance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../data-analysis/visualization/index.html" rel="next">
<link href="../../data-analysis/reshaping/index.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-a074a9bc3144aa89f5d2a8631a82ff09.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script defer="" src="https://umami.vincentgregoire.com/script.js" data-website-id="5c0abb42-9e67-4889-8e30-295fe46e640b">
</script>
<script src="../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../data-analysis/index.html">Working with Data</a></li><li class="breadcrumb-item"><a href="../../data-analysis/joins/index.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Joins and Merges</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Empirical Finance</a> 
        <div class="sidebar-tools-main">
    <a href="../../Empirical-Finance.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About This Book</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../python/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Python</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/install/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Installing Python</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/python-basics/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Python Syntax</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/oop/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Object-Oriented Programming Basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/code-quality/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Code Quality and Documentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/testing/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Error Handling and Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/logging/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Logging and Configuration</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/tools/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Development Environment and Tools</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/git/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Version Control using Git and GitHub</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/ai-for-coding/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Using AI for Coding in Empirical Research</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/devcontainers/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Stay Safe with Devcontainers</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../data-analysis/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Working with Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/dataframes/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Introduction to DataFrames</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/io/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Data Input and File Formats</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/cleaning/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Data Cleaning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/structuring/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Data Structuring and Aggregation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/reshaping/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Reshaping Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/joins/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Joins and Merges</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Visualization and Research Output</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/visualization/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Data Visualization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/tables/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Tables for Research</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/quarto/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Reproducible Documents with Quarto</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#join-types-cardinality-matters" id="toc-join-types-cardinality-matters" class="nav-link active" data-scroll-target="#join-types-cardinality-matters"><span class="header-section-number">16.1</span> Join Types: Cardinality Matters</a>
  <ul class="collapse">
  <li><a href="#one-to-one-joins" id="toc-one-to-one-joins" class="nav-link" data-scroll-target="#one-to-one-joins"><span class="header-section-number">16.1.1</span> One-to-One Joins</a></li>
  <li><a href="#one-to-many-joins" id="toc-one-to-many-joins" class="nav-link" data-scroll-target="#one-to-many-joins"><span class="header-section-number">16.1.2</span> One-to-Many Joins</a></li>
  <li><a href="#many-to-many-joins" id="toc-many-to-many-joins" class="nav-link" data-scroll-target="#many-to-many-joins"><span class="header-section-number">16.1.3</span> Many-to-Many Joins</a></li>
  </ul></li>
  <li><a href="#merge-operations-which-rows-survive" id="toc-merge-operations-which-rows-survive" class="nav-link" data-scroll-target="#merge-operations-which-rows-survive"><span class="header-section-number">16.2</span> Merge Operations: Which Rows Survive?</a>
  <ul class="collapse">
  <li><a href="#inner-join-intersection-only" id="toc-inner-join-intersection-only" class="nav-link" data-scroll-target="#inner-join-intersection-only"><span class="header-section-number">16.2.1</span> Inner Join: Intersection Only</a></li>
  <li><a href="#left-join-keep-all-from-left-dataset" id="toc-left-join-keep-all-from-left-dataset" class="nav-link" data-scroll-target="#left-join-keep-all-from-left-dataset"><span class="header-section-number">16.2.2</span> Left Join: Keep All from Left Dataset</a></li>
  <li><a href="#right-join-keep-all-from-right-dataset" id="toc-right-join-keep-all-from-right-dataset" class="nav-link" data-scroll-target="#right-join-keep-all-from-right-dataset"><span class="header-section-number">16.2.3</span> Right Join: Keep All from Right Dataset</a></li>
  <li><a href="#outer-join-keep-everything" id="toc-outer-join-keep-everything" class="nav-link" data-scroll-target="#outer-join-keep-everything"><span class="header-section-number">16.2.4</span> Outer Join: Keep Everything</a></li>
  <li><a href="#polars-merge-syntax" id="toc-polars-merge-syntax" class="nav-link" data-scroll-target="#polars-merge-syntax"><span class="header-section-number">16.2.5</span> Polars Merge Syntax</a></li>
  </ul></li>
  <li><a href="#asof-joins-for-time-series-data" id="toc-asof-joins-for-time-series-data" class="nav-link" data-scroll-target="#asof-joins-for-time-series-data"><span class="header-section-number">16.3</span> Asof Joins for Time-Series Data</a>
  <ul class="collapse">
  <li><a href="#the-asof-join-problem" id="toc-the-asof-join-problem" class="nav-link" data-scroll-target="#the-asof-join-problem"><span class="header-section-number">16.3.1</span> The Asof Join Problem</a></li>
  <li><a href="#asof-join-mechanics" id="toc-asof-join-mechanics" class="nav-link" data-scroll-target="#asof-join-mechanics"><span class="header-section-number">16.3.2</span> Asof Join Mechanics</a></li>
  <li><a href="#asof-join-directions" id="toc-asof-join-directions" class="nav-link" data-scroll-target="#asof-join-directions"><span class="header-section-number">16.3.3</span> Asof Join Directions</a></li>
  <li><a href="#asof-joins-in-polars" id="toc-asof-joins-in-polars" class="nav-link" data-scroll-target="#asof-joins-in-polars"><span class="header-section-number">16.3.4</span> Asof Joins in Polars</a></li>
  <li><a href="#common-asof-join-patterns-in-finance" id="toc-common-asof-join-patterns-in-finance" class="nav-link" data-scroll-target="#common-asof-join-patterns-in-finance"><span class="header-section-number">16.3.5</span> Common Asof Join Patterns in Finance</a></li>
  </ul></li>
  <li><a href="#diagnosing-and-correcting-merge-errors" id="toc-diagnosing-and-correcting-merge-errors" class="nav-link" data-scroll-target="#diagnosing-and-correcting-merge-errors"><span class="header-section-number">16.4</span> Diagnosing and Correcting Merge Errors</a>
  <ul class="collapse">
  <li><a href="#essential-checks-before-and-after-merging" id="toc-essential-checks-before-and-after-merging" class="nav-link" data-scroll-target="#essential-checks-before-and-after-merging"><span class="header-section-number">16.4.1</span> Essential checks before and after merging</a></li>
  <li><a href="#using-the-indicator-parameter" id="toc-using-the-indicator-parameter" class="nav-link" data-scroll-target="#using-the-indicator-parameter"><span class="header-section-number">16.4.2</span> Using the indicator parameter</a></li>
  <li><a href="#common-merge-error-patterns" id="toc-common-merge-error-patterns" class="nav-link" data-scroll-target="#common-merge-error-patterns"><span class="header-section-number">16.4.3</span> Common merge error patterns</a></li>
  </ul></li>
  <li><a href="#summary-and-best-practices" id="toc-summary-and-best-practices" class="nav-link" data-scroll-target="#summary-and-best-practices"><span class="header-section-number">16.5</span> Summary and Best Practices</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../data-analysis/index.html">Working with Data</a></li><li class="breadcrumb-item"><a href="../../data-analysis/joins/index.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Joins and Merges</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-joins" class="quarto-section-identifier"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Joins and Merges</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Combining datasets is fundamental to empirical finance. Stock returns live in one database (CRSP), accounting data in another (Compustat), analyst forecasts in a third (I/B/E/S). Real research requires merging these sources, and doing it wrong can silently corrupt your results.</p>
<p>This chapter develops the theory and practice of joins. We start with the conceptual framework—what happens when you match rows between datasets—then move to specific merge operations. Special attention goes to asof joins, essential for time-series data with mismatched timestamps. We close with diagnostic techniques to catch the merge errors that plague real-world research.</p>
<section id="join-types-cardinality-matters" class="level2" data-number="16.1">
<h2 data-number="16.1" class="anchored" data-anchor-id="join-types-cardinality-matters"><span class="header-section-number">16.1</span> Join Types: Cardinality Matters</h2>
<p>Before learning merge syntax, understand what happens to row counts. The relationship between keys in your datasets determines whether you end up with more rows, fewer rows, or the same number. Getting this wrong is catastrophic—you might duplicate observations, lose data, or create spurious patterns.</p>
<section id="one-to-one-joins" class="level3" data-number="16.1.1">
<h3 data-number="16.1.1" class="anchored" data-anchor-id="one-to-one-joins"><span class="header-section-number">16.1.1</span> One-to-One Joins</h3>
<p>Each key appears at most once in both datasets. This is the simplest case: rows either match or they don’t.</p>
<div class="cell" data-fig-width="4" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph LR
    subgraph "Dataset A"
        A1[ticker: AAPL&lt;br/&gt;ret: 0.02]
        A2[ticker: MSFT&lt;br/&gt;ret: -0.01]
    end

    subgraph "Dataset B"
        B1[ticker: AAPL&lt;br/&gt;mktcap: 2500B]
        B2[ticker: MSFT&lt;br/&gt;mktcap: 2200B]
    end

    A1 -.-&gt;|match| B1
    A2 -.-&gt;|match| B2

    style A1 fill:#e1f5ff
    style A2 fill:#e1f5ff
    style B1 fill:#fff4e1
    style B2 fill:#fff4e1
</pre>
</div>
<p></p><figcaption> One-to-one join: each key matches at most once</figcaption> </figure><p></p>
</div>
</div>
</div>
<p>Example: merging monthly portfolio returns with portfolio characteristics. Each portfolio-month appears once in each dataset.</p>
<div id="7df1ee40" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-1"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-1-1"><a href="#annotated-cell-1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="annotated-cell-1-2"><a href="#annotated-cell-1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="annotated-cell-1-3"><a href="#annotated-cell-1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="annotated-cell-1-4"><a href="#annotated-cell-1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-5"><a href="#annotated-cell-1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly portfolio returns</span></span>
<span id="annotated-cell-1-6"><a href="#annotated-cell-1-6" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> pd.DataFrame({</span>
<span id="annotated-cell-1-7"><a href="#annotated-cell-1-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'portfolio'</span>: [<span class="st">'growth'</span>, <span class="st">'value'</span>, <span class="st">'momentum'</span>],</span>
<span id="annotated-cell-1-8"><a href="#annotated-cell-1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'month'</span>: [<span class="st">'2024-01'</span>, <span class="st">'2024-01'</span>, <span class="st">'2024-01'</span>],</span>
<span id="annotated-cell-1-9"><a href="#annotated-cell-1-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'return'</span>: [<span class="fl">0.025</span>, <span class="op">-</span><span class="fl">0.010</span>, <span class="fl">0.035</span>]</span>
<span id="annotated-cell-1-10"><a href="#annotated-cell-1-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="annotated-cell-1-11"><a href="#annotated-cell-1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-12"><a href="#annotated-cell-1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Portfolio characteristics (computed separately)</span></span>
<span id="annotated-cell-1-13"><a href="#annotated-cell-1-13" aria-hidden="true" tabindex="-1"></a>characteristics <span class="op">=</span> pd.DataFrame({</span>
<span id="annotated-cell-1-14"><a href="#annotated-cell-1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'portfolio'</span>: [<span class="st">'growth'</span>, <span class="st">'value'</span>, <span class="st">'momentum'</span>],</span>
<span id="annotated-cell-1-15"><a href="#annotated-cell-1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'month'</span>: [<span class="st">'2024-01'</span>, <span class="st">'2024-01'</span>, <span class="st">'2024-01'</span>],</span>
<span id="annotated-cell-1-16"><a href="#annotated-cell-1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'avg_size'</span>: [<span class="dv">5000</span>, <span class="dv">3000</span>, <span class="dv">4000</span>],</span>
<span id="annotated-cell-1-17"><a href="#annotated-cell-1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'avg_bm'</span>: [<span class="fl">0.5</span>, <span class="fl">2.5</span>, <span class="fl">1.2</span>]</span>
<span id="annotated-cell-1-18"><a href="#annotated-cell-1-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="annotated-cell-1-19"><a href="#annotated-cell-1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-20"><a href="#annotated-cell-1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># One-to-one merge</span></span>
<span id="annotated-cell-1-21"><a href="#annotated-cell-1-21" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> returns.merge(</span>
<span id="annotated-cell-1-22"><a href="#annotated-cell-1-22" aria-hidden="true" tabindex="-1"></a>    characteristics,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="1">1</button><span id="annotated-cell-1-23" class="code-annotation-target"><a href="#annotated-cell-1-23" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">'portfolio'</span>, <span class="st">'month'</span>],</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="2">2</button><span id="annotated-cell-1-24" class="code-annotation-target"><a href="#annotated-cell-1-24" aria-hidden="true" tabindex="-1"></a>    validate<span class="op">=</span><span class="st">'one_to_one'</span></span>
<span id="annotated-cell-1-25"><a href="#annotated-cell-1-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-1-26"><a href="#annotated-cell-1-26" aria-hidden="true" tabindex="-1"></a>merged</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-1" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="23" data-code-annotation="1">Columns that must match exactly in both DataFrames.</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="24" data-code-annotation="2">Raises <code>MergeError</code> if duplicate keys exist in either DataFrame.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">portfolio</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">avg_size</th>
<th data-quarto-table-cell-role="th">avg_bm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>growth</td>
<td>2024-01</td>
<td>0.025</td>
<td>5000</td>
<td>0.5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>value</td>
<td>2024-01</td>
<td>-0.010</td>
<td>3000</td>
<td>2.5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>momentum</td>
<td>2024-01</td>
<td>0.035</td>
<td>4000</td>
<td>1.2</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Always Validate Cardinality
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use <code>validate='one_to_one'</code> in pandas or check row counts before and after. One-to-one merges should never change the number of rows (except for unmatched keys with inner joins). If row count changes unexpectedly, you have duplicate keys somewhere.</p>
</div>
</div>
</section>
<section id="one-to-many-joins" class="level3" data-number="16.1.2">
<h3 data-number="16.1.2" class="anchored" data-anchor-id="one-to-many-joins"><span class="header-section-number">16.1.2</span> One-to-Many Joins</h3>
<p>Keys are unique in one dataset but repeated in the other. This expands rows from the unique side.</p>
<div class="cell" data-fig-width="4" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph LR
    subgraph "Firms (One)"
        F1[permno: 10107&lt;br/&gt;sector: Tech]
    end

    subgraph "Returns (Many)"
        R1[permno: 10107&lt;br/&gt;date: 2024-01-02&lt;br/&gt;ret: 0.01]
        R2[permno: 10107&lt;br/&gt;date: 2024-01-03&lt;br/&gt;ret: -0.02]
        R3[permno: 10107&lt;br/&gt;date: 2024-01-04&lt;br/&gt;ret: 0.03]
    end

    F1 -.-&gt;|broadcast| R1
    F1 -.-&gt;|broadcast| R2
    F1 -.-&gt;|broadcast| R3

    style F1 fill:#e1f5ff
    style R1 fill:#fff4e1
    style R2 fill:#fff4e1
    style R3 fill:#fff4e1
</pre>
</div>
<p></p><figcaption> One-to-many join: firm-level data matched to daily returns</figcaption> </figure><p></p>
</div>
</div>
</div>
<p>Example: merging firm characteristics (one row per firm) with daily returns (many rows per firm).</p>
<div id="54dafe6c" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Firm characteristics (one row per firm)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>firms <span class="op">=</span> pd.DataFrame({</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'permno'</span>: [<span class="dv">10107</span>, <span class="dv">10107</span>, <span class="dv">14593</span>],</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span>: [<span class="dv">2023</span>, <span class="dv">2024</span>, <span class="dv">2024</span>],</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sector'</span>: [<span class="st">'Tech'</span>, <span class="st">'Tech'</span>, <span class="st">'Finance'</span>],</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'headquarters'</span>: [<span class="st">'CA'</span>, <span class="st">'CA'</span>, <span class="st">'NY'</span>]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily returns (many rows per firm-year)</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> pd.DataFrame({</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'permno'</span>: [<span class="dv">10107</span>, <span class="dv">10107</span>, <span class="dv">10107</span>, <span class="dv">14593</span>, <span class="dv">14593</span>],</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span>: [<span class="dv">2024</span>, <span class="dv">2024</span>, <span class="dv">2024</span>, <span class="dv">2024</span>, <span class="dv">2024</span>],</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'date'</span>: [<span class="st">'2024-01-02'</span>, <span class="st">'2024-01-03'</span>, <span class="st">'2024-01-04'</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">'2024-01-02'</span>, <span class="st">'2024-01-03'</span>],</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ret'</span>: [<span class="fl">0.01</span>, <span class="op">-</span><span class="fl">0.02</span>, <span class="fl">0.03</span>, <span class="fl">0.005</span>, <span class="op">-</span><span class="fl">0.001</span>]</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># One-to-many merge: firm characteristics broadcast to each return</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> returns.merge(</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    firms,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">'permno'</span>, <span class="st">'year'</span>],</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    validate<span class="op">=</span><span class="st">'many_to_one'</span>  <span class="co"># Ensures firms has unique keys</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>merged</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">permno</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ret</th>
<th data-quarto-table-cell-role="th">sector</th>
<th data-quarto-table-cell-role="th">headquarters</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>10107</td>
<td>2024</td>
<td>2024-01-02</td>
<td>0.010</td>
<td>Tech</td>
<td>CA</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>10107</td>
<td>2024</td>
<td>2024-01-03</td>
<td>-0.020</td>
<td>Tech</td>
<td>CA</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>10107</td>
<td>2024</td>
<td>2024-01-04</td>
<td>0.030</td>
<td>Tech</td>
<td>CA</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>14593</td>
<td>2024</td>
<td>2024-01-02</td>
<td>0.005</td>
<td>Finance</td>
<td>NY</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>14593</td>
<td>2024</td>
<td>2024-01-03</td>
<td>-0.001</td>
<td>Finance</td>
<td>NY</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Notice how <code>sector</code> and <code>headquarters</code> repeat for each date. This is broadcasting: the single firm row expands to match multiple return rows.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Watch for Unintended Duplicates
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you think you have a one-to-many join but the “one” side has duplicates, you’ll get a many-to-many join instead. This multiplies rows in ways that corrupt analyses. Always validate.</p>
</div>
</div>
</section>
<section id="many-to-many-joins" class="level3" data-number="16.1.3">
<h3 data-number="16.1.3" class="anchored" data-anchor-id="many-to-many-joins"><span class="header-section-number">16.1.3</span> Many-to-Many Joins</h3>
<p>Keys repeat in both datasets. Every combination of matching keys produces a row. This explodes row counts and is rarely what you want.</p>
<div class="cell" data-fig-width="4" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph LR
    subgraph "Dataset A (Many)"
        A1[sector: Tech&lt;br/&gt;year: 2024&lt;br/&gt;firm: AAPL]
        A2[sector: Tech&lt;br/&gt;year: 2024&lt;br/&gt;firm: MSFT]
    end

    subgraph "Dataset B (Many)"
        B1[sector: Tech&lt;br/&gt;year: 2024&lt;br/&gt;analyst: Goldman]
        B2[sector: Tech&lt;br/&gt;year: 2024&lt;br/&gt;analyst: Morgan]
    end

    A1 -.-&gt;|match| B1
    A1 -.-&gt;|match| B2
    A2 -.-&gt;|match| B1
    A2 -.-&gt;|match| B2

    style A1 fill:#e1f5ff
    style A2 fill:#e1f5ff
    style B1 fill:#fff4e1
    style B2 fill:#fff4e1
</pre>
</div>
<p></p><figcaption> Many-to-many join: combinatorial explosion</figcaption> </figure><p></p>
</div>
</div>
</div>
<p>Example: joining firm-level data to analyst coverage by sector-year creates all combinations.</p>
<div id="70de1f00" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Firms in each sector-year</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>firms <span class="op">=</span> pd.DataFrame({</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sector'</span>: [<span class="st">'Tech'</span>, <span class="st">'Tech'</span>, <span class="st">'Finance'</span>],</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span>: [<span class="dv">2024</span>, <span class="dv">2024</span>, <span class="dv">2024</span>],</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>, <span class="st">'MSFT'</span>, <span class="st">'JPM'</span>],</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'return'</span>: [<span class="fl">0.25</span>, <span class="fl">0.30</span>, <span class="fl">0.15</span>]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyst reports by sector-year (multiple analysts per sector)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>analysts <span class="op">=</span> pd.DataFrame({</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sector'</span>: [<span class="st">'Tech'</span>, <span class="st">'Tech'</span>, <span class="st">'Finance'</span>],</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span>: [<span class="dv">2024</span>, <span class="dv">2024</span>, <span class="dv">2024</span>],</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'analyst'</span>: [<span class="st">'Goldman'</span>, <span class="st">'Morgan'</span>, <span class="st">'Citi'</span>],</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'recommendation'</span>: [<span class="st">'Buy'</span>, <span class="st">'Hold'</span>, <span class="st">'Buy'</span>]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Many-to-many merge: </span><span class="al">DANGER</span><span class="co">!</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> firms.merge(analysts, on<span class="op">=</span>[<span class="st">'sector'</span>, <span class="st">'year'</span>])</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>merged</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sector</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">analyst</th>
<th data-quarto-table-cell-role="th">recommendation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Tech</td>
<td>2024</td>
<td>AAPL</td>
<td>0.25</td>
<td>Goldman</td>
<td>Buy</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Tech</td>
<td>2024</td>
<td>AAPL</td>
<td>0.25</td>
<td>Morgan</td>
<td>Hold</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Tech</td>
<td>2024</td>
<td>MSFT</td>
<td>0.30</td>
<td>Goldman</td>
<td>Buy</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Tech</td>
<td>2024</td>
<td>MSFT</td>
<td>0.30</td>
<td>Morgan</td>
<td>Hold</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Finance</td>
<td>2024</td>
<td>JPM</td>
<td>0.15</td>
<td>Citi</td>
<td>Buy</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Notice how the row count exploded:</p>
<div id="b5413427" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Original firms: </span><span class="sc">{</span><span class="bu">len</span>(firms)<span class="sc">}</span><span class="ss">, analysts: </span><span class="sc">{</span><span class="bu">len</span>(analysts)<span class="sc">}</span><span class="ss">, merged: </span><span class="sc">{</span><span class="bu">len</span>(merged)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original firms: 3, analysts: 3, merged: 5</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>Many-to-Many is Usually Wrong
</div>
</div>
<div class="callout-body-container callout-body">
<p>In finance, many-to-many joins typically indicate a modeling error. You probably need to aggregate one dataset first (e.g., average analyst recommendations by sector-year) or use a more specific join key. Pandas allows many-to-many by default; consider this a bug, not a feature.</p>
</div>
</div>
</section>
</section>
<section id="merge-operations-which-rows-survive" class="level2" data-number="16.2">
<h2 data-number="16.2" class="anchored" data-anchor-id="merge-operations-which-rows-survive"><span class="header-section-number">16.2</span> Merge Operations: Which Rows Survive?</h2>
<p>Join type (one-to-one, etc.) describes cardinality. Merge operation (inner, outer, left, right) describes <em>which rows to keep</em> when keys don’t match perfectly.</p>
<section id="inner-join-intersection-only" class="level3" data-number="16.2.1">
<h3 data-number="16.2.1" class="anchored" data-anchor-id="inner-join-intersection-only"><span class="header-section-number">16.2.1</span> Inner Join: Intersection Only</h3>
<p>Keep only rows where keys match in both datasets. This is conservative—you lose any observation that doesn’t have a partner—but ensures every row has complete data.</p>
<div class="cell" data-fig-width="5" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD
    subgraph "Dataset A"
        A1[AAPL]
        A2[MSFT]
        A3[TSLA]
    end

    subgraph "Dataset B"
        B1[AAPL]
        B2[GOOGL]
        B3[TSLA]
    end

    subgraph "Result"
        R1[AAPL]
        R2[TSLA]
    end

    A1 --&gt; R1
    B1 --&gt; R1
    A3 --&gt; R2
    B3 --&gt; R2

    style A2 fill:#ffcccc
    style B2 fill:#ffcccc
    style R1 fill:#ccffcc
    style R2 fill:#ccffcc
</pre>
</div>
<p></p><figcaption> Inner join: only matching keys survive</figcaption> </figure><p></p>
</div>
</div>
</div>
<p>Example: merging returns with accounting data. Only firm-years with both survive.</p>
<div id="78f2134b" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stock returns</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> pd.DataFrame({</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>, <span class="st">'MSFT'</span>, <span class="st">'TSLA'</span>],</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span>: [<span class="dv">2023</span>, <span class="dv">2023</span>, <span class="dv">2023</span>],</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'return'</span>: [<span class="fl">0.45</span>, <span class="fl">0.35</span>, <span class="fl">0.10</span>]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Accounting data (missing MSFT)</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>accounting <span class="op">=</span> pd.DataFrame({</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>, <span class="st">'TSLA'</span>, <span class="st">'GOOGL'</span>],</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span>: [<span class="dv">2023</span>, <span class="dv">2023</span>, <span class="dv">2023</span>],</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'roa'</span>: [<span class="fl">0.20</span>, <span class="fl">0.05</span>, <span class="fl">0.15</span>],</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'leverage'</span>: [<span class="fl">0.30</span>, <span class="fl">0.10</span>, <span class="fl">0.05</span>]</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Inner join: only AAPL and TSLA have both</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>inner <span class="op">=</span> returns.merge(accounting, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'year'</span>], how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>inner</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">roa</th>
<th data-quarto-table-cell-role="th">leverage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>AAPL</td>
<td>2023</td>
<td>0.45</td>
<td>0.20</td>
<td>0.3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>TSLA</td>
<td>2023</td>
<td>0.10</td>
<td>0.05</td>
<td>0.1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>When to Use Inner Joins
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use inner joins when you <em>need</em> data from both sources for your analysis. For example, computing correlations between returns and accounting ratios requires both variables. The sample restriction is a feature, not a bug—you’re explicitly limiting to observations where analysis is possible.</p>
</div>
</div>
</section>
<section id="left-join-keep-all-from-left-dataset" class="level3" data-number="16.2.2">
<h3 data-number="16.2.2" class="anchored" data-anchor-id="left-join-keep-all-from-left-dataset"><span class="header-section-number">16.2.2</span> Left Join: Keep All from Left Dataset</h3>
<p>Keep every row from the left dataset, adding data from the right where available. Unmatched right rows disappear. Missing values (NaN) fill columns from the right dataset where no match exists.</p>
<div class="cell" data-fig-width="5" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD
    subgraph "Left Dataset"
        L1[AAPL]
        L2[MSFT]
        L3[TSLA]
    end

    subgraph "Right Dataset"
        R1[AAPL]
        R2[GOOGL]
        R3[TSLA]
    end

    subgraph "Result"
        RES1[AAPL + match]
        RES2[MSFT + NaN]
        RES3[TSLA + match]
    end

    L1 --&gt; RES1
    L2 --&gt; RES2
    L3 --&gt; RES3
    R1 --&gt; RES1
    R3 --&gt; RES3

    style R2 fill:#ffcccc
    style RES1 fill:#ccffcc
    style RES2 fill:#ffffcc
    style RES3 fill:#ccffcc
</pre>
</div>
<p></p><figcaption> Left join: all left-side rows survive, right-side data added where available</figcaption> </figure><p></p>
</div>
</div>
</div>
<p>Example: keeping all returns, adding accounting data where available.</p>
<div id="155783f5" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Left join: keep all returns</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>left <span class="op">=</span> returns.merge(accounting, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'year'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>left</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">roa</th>
<th data-quarto-table-cell-role="th">leverage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>AAPL</td>
<td>2023</td>
<td>0.45</td>
<td>0.20</td>
<td>0.3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>MSFT</td>
<td>2023</td>
<td>0.35</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>TSLA</td>
<td>2023</td>
<td>0.10</td>
<td>0.05</td>
<td>0.1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Left Joins Preserve Sample
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use left joins when the left dataset defines your sample. For example, if you’ve carefully constructed a set of stocks for analysis, use those as the left dataset and merge in additional characteristics. This ensures you keep your full sample even if some characteristics are missing.</p>
</div>
</div>
</section>
<section id="right-join-keep-all-from-right-dataset" class="level3" data-number="16.2.3">
<h3 data-number="16.2.3" class="anchored" data-anchor-id="right-join-keep-all-from-right-dataset"><span class="header-section-number">16.2.3</span> Right Join: Keep All from Right Dataset</h3>
<p>The mirror of left join. Keep every row from the right dataset, add data from left where available. In practice, just swap your datasets and use a left join—right joins exist for symmetry but rarely clarify code.</p>
<div id="bdf07eec" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Right join: keep all accounting observations</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>right <span class="op">=</span> returns.merge(accounting, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'year'</span>], how<span class="op">=</span><span class="st">'right'</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>right</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">roa</th>
<th data-quarto-table-cell-role="th">leverage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>AAPL</td>
<td>2023</td>
<td>0.45</td>
<td>0.20</td>
<td>0.30</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>TSLA</td>
<td>2023</td>
<td>0.10</td>
<td>0.05</td>
<td>0.10</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>GOOGL</td>
<td>2023</td>
<td>NaN</td>
<td>0.15</td>
<td>0.05</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Prefer Left Joins for Clarity
</div>
</div>
<div class="callout-body-container callout-body">
<p>Write <code>accounting.merge(returns, how='left')</code> instead of <code>returns.merge(accounting, how='right')</code>. Reading left-to-right matches execution order and makes the priority explicit: you’re starting with accounting data and adding returns.</p>
</div>
</div>
</section>
<section id="outer-join-keep-everything" class="level3" data-number="16.2.4">
<h3 data-number="16.2.4" class="anchored" data-anchor-id="outer-join-keep-everything"><span class="header-section-number">16.2.4</span> Outer Join: Keep Everything</h3>
<p>Keep all rows from both datasets. This maximizes sample size but can create large numbers of missing values.</p>
<div class="cell" data-fig-width="5" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD
    subgraph "Dataset A"
        A1[AAPL]
        A2[MSFT]
        A3[TSLA]
    end

    subgraph "Dataset B"
        B1[AAPL]
        B2[GOOGL]
        B3[TSLA]
    end

    subgraph "Result"
        R1[AAPL + match]
        R2[MSFT + NaN]
        R3[TSLA + match]
        R4[GOOGL + NaN]
    end

    A1 --&gt; R1
    A2 --&gt; R2
    A3 --&gt; R3
    B1 --&gt; R1
    B2 --&gt; R4
    B3 --&gt; R3

    style R1 fill:#ccffcc
    style R2 fill:#ffffcc
    style R3 fill:#ccffcc
    style R4 fill:#ffffcc
</pre>
</div>
<p></p><figcaption> Outer join: all rows from both datasets survive</figcaption> </figure><p></p>
</div>
</div>
</div>
<p>Example: keeping all tickers from either dataset.</p>
<div id="fa762a2e" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Outer join: keep everything</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>outer <span class="op">=</span> returns.merge(accounting, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'year'</span>], how<span class="op">=</span><span class="st">'outer'</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>outer</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">roa</th>
<th data-quarto-table-cell-role="th">leverage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>AAPL</td>
<td>2023</td>
<td>0.45</td>
<td>0.20</td>
<td>0.30</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>GOOGL</td>
<td>2023</td>
<td>NaN</td>
<td>0.15</td>
<td>0.05</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>MSFT</td>
<td>2023</td>
<td>0.35</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>TSLA</td>
<td>2023</td>
<td>0.10</td>
<td>0.05</td>
<td>0.10</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Outer Joins Hide Problems
</div>
</div>
<div class="callout-body-container callout-body">
<p>Outer joins are dangerous because they succeed even when keys match poorly. You might merge stock returns with bond yields on date, get mostly NaN, but never realize the datasets use different date formats. Always inspect outer join results carefully and report match rates.</p>
</div>
</div>
</section>
<section id="polars-merge-syntax" class="level3" data-number="16.2.5">
<h3 data-number="16.2.5" class="anchored" data-anchor-id="polars-merge-syntax"><span class="header-section-number">16.2.5</span> Polars Merge Syntax</h3>
<p>Polars uses similar concepts but different method names. The key difference: Polars is more explicit about join types and discourages many-to-many joins by default.</p>
<div id="0753292a" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same data in Polars</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>returns_pl <span class="op">=</span> pl.DataFrame({</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>, <span class="st">'MSFT'</span>, <span class="st">'TSLA'</span>],</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span>: [<span class="dv">2023</span>, <span class="dv">2023</span>, <span class="dv">2023</span>],</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'return'</span>: [<span class="fl">0.45</span>, <span class="fl">0.35</span>, <span class="fl">0.10</span>]</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>accounting_pl <span class="op">=</span> pl.DataFrame({</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>, <span class="st">'TSLA'</span>, <span class="st">'GOOGL'</span>],</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span>: [<span class="dv">2023</span>, <span class="dv">2023</span>, <span class="dv">2023</span>],</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'roa'</span>: [<span class="fl">0.20</span>, <span class="fl">0.05</span>, <span class="fl">0.15</span>],</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'leverage'</span>: [<span class="fl">0.30</span>, <span class="fl">0.10</span>, <span class="fl">0.05</span>]</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Inner join</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>inner_pl <span class="op">=</span> returns_pl.join(</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    accounting_pl,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'year'</span>],</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>inner_pl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (2, 5)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">roa</th>
<th data-quarto-table-cell-role="th">leverage</th>
</tr>
<tr class="even">
<td>str</td>
<td>i64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"AAPL"</td>
<td>2023</td>
<td>0.45</td>
<td>0.2</td>
<td>0.3</td>
</tr>
<tr class="even">
<td>"TSLA"</td>
<td>2023</td>
<td>0.1</td>
<td>0.05</td>
<td>0.1</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="051d5507" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Left join</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>left_pl <span class="op">=</span> returns_pl.join(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    accounting_pl,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'year'</span>],</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>left_pl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (3, 5)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">roa</th>
<th data-quarto-table-cell-role="th">leverage</th>
</tr>
<tr class="even">
<td>str</td>
<td>i64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"AAPL"</td>
<td>2023</td>
<td>0.45</td>
<td>0.2</td>
<td>0.3</td>
</tr>
<tr class="even">
<td>"MSFT"</td>
<td>2023</td>
<td>0.35</td>
<td>null</td>
<td>null</td>
</tr>
<tr class="odd">
<td>"TSLA"</td>
<td>2023</td>
<td>0.1</td>
<td>0.05</td>
<td>0.1</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="ec7e00fe" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Outer join (called 'full' in Polars)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>outer_pl <span class="op">=</span> returns_pl.join(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    accounting_pl,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'year'</span>],</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'full'</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>outer_pl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (4, 7)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">ticker_right</th>
<th data-quarto-table-cell-role="th">year_right</th>
<th data-quarto-table-cell-role="th">roa</th>
<th data-quarto-table-cell-role="th">leverage</th>
</tr>
<tr class="even">
<td>str</td>
<td>i64</td>
<td>f64</td>
<td>str</td>
<td>i64</td>
<td>f64</td>
<td>f64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>"AAPL"</td>
<td>2023</td>
<td>0.45</td>
<td>"AAPL"</td>
<td>2023</td>
<td>0.2</td>
<td>0.3</td>
</tr>
<tr class="even">
<td>"TSLA"</td>
<td>2023</td>
<td>0.1</td>
<td>"TSLA"</td>
<td>2023</td>
<td>0.05</td>
<td>0.1</td>
</tr>
<tr class="odd">
<td>null</td>
<td>null</td>
<td>null</td>
<td>"GOOGL"</td>
<td>2023</td>
<td>0.15</td>
<td>0.05</td>
</tr>
<tr class="even">
<td>"MSFT"</td>
<td>2023</td>
<td>0.35</td>
<td>null</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Polars also provides a <code>validate</code> parameter similar to pandas:</p>
<div id="706d2024" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Validate one-to-one</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>inner_pl <span class="op">=</span> returns_pl.join(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    accounting_pl,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'year'</span>],</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'inner'</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    validate<span class="op">=</span><span class="st">'1:1'</span>  <span class="co"># Raises error if violated</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="asof-joins-for-time-series-data" class="level2" data-number="16.3">
<h2 data-number="16.3" class="anchored" data-anchor-id="asof-joins-for-time-series-data"><span class="header-section-number">16.3</span> Asof Joins for Time-Series Data</h2>
<p>Financial data rarely aligns perfectly in time. You have daily stock prices, quarterly earnings announcements, irregular analyst forecast updates. Matching these requires asof joins: find the most recent value as of each timestamp, without requiring exact matches.</p>
<section id="the-asof-join-problem" class="level3" data-number="16.3.1">
<h3 data-number="16.3.1" class="anchored" data-anchor-id="the-asof-join-problem"><span class="header-section-number">16.3.1</span> The Asof Join Problem</h3>
<p>Suppose you want to merge earnings announcement dates with stock returns. Earnings come out on irregular dates (whenever the company reports). You need to tag each daily return with the most recent earnings announcement as of that date. A standard merge fails because announcement dates don’t match return dates. An asof join solves this: for each return date, find the most recent announcement date on or before that date.</p>
</section>
<section id="asof-join-mechanics" class="level3" data-number="16.3.2">
<h3 data-number="16.3.2" class="anchored" data-anchor-id="asof-join-mechanics"><span class="header-section-number">16.3.2</span> Asof Join Mechanics</h3>
<p>Asof joins require sorted data and directional matching. The syntax varies between pandas and Polars, but the logic is identical:</p>
<ol type="1">
<li>Sort both datasets by time</li>
<li>For each row in the left dataset, find the row in the right dataset with the closest timestamp that doesn’t exceed the left timestamp (backward-looking)</li>
<li>Optionally match exactly on other columns (e.g., ticker)</li>
</ol>
<p>Example: merging daily returns with quarterly earnings.</p>
<div id="a92e3e98" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-13"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-13-1"><a href="#annotated-cell-13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="annotated-cell-13-2"><a href="#annotated-cell-13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-3"><a href="#annotated-cell-13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily returns (many observations)</span></span>
<span id="annotated-cell-13-4"><a href="#annotated-cell-13-4" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> pd.DataFrame({</span>
<span id="annotated-cell-13-5"><a href="#annotated-cell-13-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>] <span class="op">*</span> <span class="dv">10</span>,</span>
<span id="annotated-cell-13-6"><a href="#annotated-cell-13-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'date'</span>: pd.date_range(<span class="st">'2024-01-01'</span>, periods<span class="op">=</span><span class="dv">10</span>, freq<span class="op">=</span><span class="st">'D'</span>),</span>
<span id="annotated-cell-13-7"><a href="#annotated-cell-13-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'return'</span>: np.random.randn(<span class="dv">10</span>) <span class="op">*</span> <span class="fl">0.02</span></span>
<span id="annotated-cell-13-8"><a href="#annotated-cell-13-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="annotated-cell-13-9"><a href="#annotated-cell-13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-10"><a href="#annotated-cell-13-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Earnings announcements (sparse, irregular)</span></span>
<span id="annotated-cell-13-11"><a href="#annotated-cell-13-11" aria-hidden="true" tabindex="-1"></a>earnings <span class="op">=</span> pd.DataFrame({</span>
<span id="annotated-cell-13-12"><a href="#annotated-cell-13-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>, <span class="st">'AAPL'</span>, <span class="st">'AAPL'</span>],</span>
<span id="annotated-cell-13-13"><a href="#annotated-cell-13-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'announce_date'</span>: pd.to_datetime([<span class="st">'2023-12-28'</span>, <span class="st">'2024-01-03'</span>, <span class="st">'2024-01-08'</span>]),</span>
<span id="annotated-cell-13-14"><a href="#annotated-cell-13-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'eps'</span>: [<span class="fl">1.25</span>, <span class="fl">1.30</span>, <span class="fl">1.35</span>],</span>
<span id="annotated-cell-13-15"><a href="#annotated-cell-13-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'surprise'</span>: [<span class="fl">0.02</span>, <span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.03</span>]</span>
<span id="annotated-cell-13-16"><a href="#annotated-cell-13-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="annotated-cell-13-17"><a href="#annotated-cell-13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-18"><a href="#annotated-cell-13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># CRITICAL: Sort by time</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="1">1</button><span id="annotated-cell-13-19" class="code-annotation-target"><a href="#annotated-cell-13-19" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> returns.sort_values(<span class="st">'date'</span>)</span>
<span id="annotated-cell-13-20"><a href="#annotated-cell-13-20" aria-hidden="true" tabindex="-1"></a>earnings <span class="op">=</span> earnings.sort_values(<span class="st">'announce_date'</span>)</span>
<span id="annotated-cell-13-21"><a href="#annotated-cell-13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-22"><a href="#annotated-cell-13-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Asof join: match each return to most recent earnings</span></span>
<span id="annotated-cell-13-23"><a href="#annotated-cell-13-23" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> pd.merge_asof(</span>
<span id="annotated-cell-13-24"><a href="#annotated-cell-13-24" aria-hidden="true" tabindex="-1"></a>    returns,</span>
<span id="annotated-cell-13-25"><a href="#annotated-cell-13-25" aria-hidden="true" tabindex="-1"></a>    earnings,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="2">2</button><span id="annotated-cell-13-26" class="code-annotation-target"><a href="#annotated-cell-13-26" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'date'</span>,</span>
<span id="annotated-cell-13-27"><a href="#annotated-cell-13-27" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'announce_date'</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="3">3</button><span id="annotated-cell-13-28" class="code-annotation-target"><a href="#annotated-cell-13-28" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span><span class="st">'ticker'</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="4">4</button><span id="annotated-cell-13-29" class="code-annotation-target"><a href="#annotated-cell-13-29" aria-hidden="true" tabindex="-1"></a>    direction<span class="op">=</span><span class="st">'backward'</span></span>
<span id="annotated-cell-13-30"><a href="#annotated-cell-13-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-13-31"><a href="#annotated-cell-13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-13-32"><a href="#annotated-cell-13-32" aria-hidden="true" tabindex="-1"></a>merged[[<span class="st">'date'</span>, <span class="st">'return'</span>, <span class="st">'announce_date'</span>, <span class="st">'eps'</span>, <span class="st">'surprise'</span>]]</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-13" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="19,20" data-code-annotation="1">Both DataFrames must be sorted by their time columns before asof join.</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="26,27" data-code-annotation="2">Time columns to match on (can have different names).</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="28" data-code-annotation="3">Additional columns that must match exactly.</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="29" data-code-annotation="4">Use most recent prior value (avoids look-ahead bias).</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">announce_date</th>
<th data-quarto-table-cell-role="th">eps</th>
<th data-quarto-table-cell-role="th">surprise</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>-0.032470</td>
<td>2023-12-28</td>
<td>1.25</td>
<td>0.02</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>0.023386</td>
<td>2023-12-28</td>
<td>1.25</td>
<td>0.02</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>-0.040501</td>
<td>2024-01-03</td>
<td>1.30</td>
<td>-0.01</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>-0.017916</td>
<td>2024-01-03</td>
<td>1.30</td>
<td>-0.01</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>-0.004434</td>
<td>2024-01-03</td>
<td>1.30</td>
<td>-0.01</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>-0.020436</td>
<td>2024-01-03</td>
<td>1.30</td>
<td>-0.01</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-07</td>
<td>-0.024500</td>
<td>2024-01-03</td>
<td>1.30</td>
<td>-0.01</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-08</td>
<td>0.046251</td>
<td>2024-01-08</td>
<td>1.35</td>
<td>0.03</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-09</td>
<td>-0.013361</td>
<td>2024-01-08</td>
<td>1.35</td>
<td>0.03</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-10</td>
<td>0.024632</td>
<td>2024-01-08</td>
<td>1.35</td>
<td>0.03</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Notice how the earnings data “fills forward”:</p>
<ul>
<li>Jan 1-2 use the Dec 28 announcement</li>
<li>Jan 3-7 use the Jan 3 announcement</li>
<li>Jan 8+ use the Jan 8 announcement</li>
</ul>
<p>This is exactly what you want for event studies: tag each return with the most recent earnings information available at that time.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Asof Joins Require Sorted Data
</div>
</div>
<div class="callout-body-container callout-body">
<p>Both datasets must be sorted by the time column. Pandas doesn’t always check this, and unsorted data produces wrong results silently. Always sort explicitly before asof joins.</p>
</div>
</div>
</section>
<section id="asof-join-directions" class="level3" data-number="16.3.3">
<h3 data-number="16.3.3" class="anchored" data-anchor-id="asof-join-directions"><span class="header-section-number">16.3.3</span> Asof Join Directions</h3>
<p>The <code>direction</code> parameter controls which timestamp to match:</p>
<ul>
<li><code>direction='backward'</code> (default): Use most recent prior value (as of semantics)</li>
<li><code>direction='forward'</code>: Use next future value (rare in finance)</li>
<li><code>direction='nearest'</code>: Use closest value in either direction (dangerous for event studies—can introduce look-ahead bias)</li>
</ul>
<div id="38751cc3" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward-looking (CAREFUL: creates look-ahead bias)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>forward <span class="op">=</span> pd.merge_asof(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    returns,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    earnings,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'date'</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'announce_date'</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span><span class="st">'ticker'</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    direction<span class="op">=</span><span class="st">'forward'</span>  <span class="co"># Use next announcement</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Nearest (AVOID for event studies)</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>nearest <span class="op">=</span> pd.merge_asof(</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    returns,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    earnings,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'date'</span>,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'announce_date'</span>,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span><span class="st">'ticker'</span>,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    direction<span class="op">=</span><span class="st">'nearest'</span>  <span class="co"># Use closest announcement</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Beware Look-Ahead Bias
</div>
</div>
<div class="callout-body-container callout-body">
<p>Using <code>direction='forward'</code> or <code>direction='nearest'</code> can introduce look-ahead bias: your analysis uses information that didn’t exist at the time. For example, tagging a January return with a February earnings announcement. This inflates backtested strategy returns and invalidates empirical tests. Stick with <code>direction='backward'</code> unless you have a specific reason to do otherwise.</p>
</div>
</div>
</section>
<section id="asof-joins-in-polars" class="level3" data-number="16.3.4">
<h3 data-number="16.3.4" class="anchored" data-anchor-id="asof-joins-in-polars"><span class="header-section-number">16.3.4</span> Asof Joins in Polars</h3>
<p>Polars provides asof joins through the <code>join_asof</code> method. The syntax is cleaner and performance is often better for large datasets.</p>
<div id="35f41673" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same data in Polars</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>returns_pl <span class="op">=</span> pl.DataFrame({</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>] <span class="op">*</span> <span class="dv">10</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'date'</span>: pl.date_range(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        date(<span class="dv">2024</span>, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        date(<span class="dv">2024</span>, <span class="dv">1</span>, <span class="dv">10</span>),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        interval<span class="op">=</span><span class="st">'1d'</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        eager<span class="op">=</span><span class="va">True</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'return'</span>: np.random.randn(<span class="dv">10</span>) <span class="op">*</span> <span class="fl">0.02</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>earnings_pl <span class="op">=</span> pl.DataFrame({</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>, <span class="st">'AAPL'</span>, <span class="st">'AAPL'</span>],</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'announce_date'</span>: [</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        date(<span class="dv">2023</span>, <span class="dv">12</span>, <span class="dv">28</span>),</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        date(<span class="dv">2024</span>, <span class="dv">1</span>, <span class="dv">3</span>),</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        date(<span class="dv">2024</span>, <span class="dv">1</span>, <span class="dv">8</span>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'eps'</span>: [<span class="fl">1.25</span>, <span class="fl">1.30</span>, <span class="fl">1.35</span>],</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'surprise'</span>: [<span class="fl">0.02</span>, <span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.03</span>]</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Asof join in Polars</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>merged_pl <span class="op">=</span> returns_pl.sort(<span class="st">'date'</span>).join_asof(</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    earnings_pl.sort(<span class="st">'announce_date'</span>),</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'date'</span>,</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'announce_date'</span>,</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span><span class="st">'ticker'</span>,</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    strategy<span class="op">=</span><span class="st">'backward'</span>  <span class="co"># Equivalent to pandas direction='backward'</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>merged_pl.select([<span class="st">'date'</span>, <span class="st">'return'</span>, <span class="st">'announce_date'</span>, <span class="st">'eps'</span>, <span class="st">'surprise'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/var/folders/jr/cn9h86ld68qb5rtvs9gsb1vr0000gn/T/ipykernel_65713/4247637574.py:25: UserWarning: Sortedness of columns cannot be checked when 'by' groups provided
  merged_pl = returns_pl.sort('date').join_asof(</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 5)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">announce_date</th>
<th data-quarto-table-cell-role="th">eps</th>
<th data-quarto-table-cell-role="th">surprise</th>
</tr>
<tr class="even">
<td>date</td>
<td>f64</td>
<td>date</td>
<td>f64</td>
<td>f64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-01</td>
<td>0.01453</td>
<td>2023-12-28</td>
<td>1.25</td>
<td>0.02</td>
</tr>
<tr class="even">
<td>2024-01-02</td>
<td>0.001239</td>
<td>2023-12-28</td>
<td>1.25</td>
<td>0.02</td>
</tr>
<tr class="odd">
<td>2024-01-03</td>
<td>0.016048</td>
<td>2024-01-03</td>
<td>1.3</td>
<td>-0.01</td>
</tr>
<tr class="even">
<td>2024-01-04</td>
<td>-0.02854</td>
<td>2024-01-03</td>
<td>1.3</td>
<td>-0.01</td>
</tr>
<tr class="odd">
<td>2024-01-05</td>
<td>0.01889</td>
<td>2024-01-03</td>
<td>1.3</td>
<td>-0.01</td>
</tr>
<tr class="even">
<td>2024-01-06</td>
<td>-0.005555</td>
<td>2024-01-03</td>
<td>1.3</td>
<td>-0.01</td>
</tr>
<tr class="odd">
<td>2024-01-07</td>
<td>0.045201</td>
<td>2024-01-03</td>
<td>1.3</td>
<td>-0.01</td>
</tr>
<tr class="even">
<td>2024-01-08</td>
<td>-0.029402</td>
<td>2024-01-08</td>
<td>1.35</td>
<td>0.03</td>
</tr>
<tr class="odd">
<td>2024-01-09</td>
<td>-0.021957</td>
<td>2024-01-08</td>
<td>1.35</td>
<td>0.03</td>
</tr>
<tr class="even">
<td>2024-01-10</td>
<td>0.026204</td>
<td>2024-01-08</td>
<td>1.35</td>
<td>0.03</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Polars also supports tolerance (maximum time difference) and handles missing values more explicitly:</p>
<div id="d1db49c0" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Only match if announcement is within 90 days</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>merged_pl <span class="op">=</span> returns_pl.sort(<span class="st">'date'</span>).join_asof(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    earnings_pl.sort(<span class="st">'announce_date'</span>),</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'date'</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'announce_date'</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span><span class="st">'ticker'</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    strategy<span class="op">=</span><span class="st">'backward'</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    tolerance<span class="op">=</span><span class="st">'90d'</span>  <span class="co"># NaN if no announcement within 90 days</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="common-asof-join-patterns-in-finance" class="level3" data-number="16.3.5">
<h3 data-number="16.3.5" class="anchored" data-anchor-id="common-asof-join-patterns-in-finance"><span class="header-section-number">16.3.5</span> Common Asof Join Patterns in Finance</h3>
<p><strong>Pattern 1: Point-in-time accounting data</strong></p>
<p>Merge daily returns with quarterly accounting variables. Each return should use the most recent financial statement available at that date.</p>
<div id="e2f8d3dd" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily returns</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> pd.DataFrame({</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'permno'</span>: [<span class="dv">10107</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'date'</span>: pd.date_range(<span class="st">'2024-01-01'</span>, periods<span class="op">=</span><span class="dv">100</span>, freq<span class="op">=</span><span class="st">'D'</span>),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ret'</span>: np.random.randn(<span class="dv">100</span>) <span class="op">*</span> <span class="fl">0.02</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Quarterly accounting (fiscal quarter end dates)</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>accounting <span class="op">=</span> pd.DataFrame({</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'permno'</span>: [<span class="dv">10107</span>, <span class="dv">10107</span>, <span class="dv">10107</span>, <span class="dv">10107</span>],</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'datadate'</span>: pd.to_datetime([<span class="st">'2023-09-30'</span>, <span class="st">'2023-12-31'</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>                                <span class="st">'2024-03-31'</span>, <span class="st">'2024-06-30'</span>]),</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'book_equity'</span>: [<span class="dv">1000</span>, <span class="dv">1100</span>, <span class="dv">1150</span>, <span class="dv">1200</span>],</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'total_assets'</span>: [<span class="dv">5000</span>, <span class="dv">5200</span>, <span class="dv">5300</span>, <span class="dv">5400</span>]</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Asof join: each return uses most recent accounting data</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> pd.merge_asof(</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    returns.sort_values(<span class="st">'date'</span>),</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    accounting.sort_values(<span class="st">'datadate'</span>),</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'date'</span>,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'datadate'</span>,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span><span class="st">'permno'</span>,</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    direction<span class="op">=</span><span class="st">'backward'</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Pattern 2: Analyst forecast updates</strong></p>
<p>Analyst forecasts arrive irregularly. Tag each return with the current consensus forecast.</p>
<div id="ebea7878" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily returns</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> pd.DataFrame({</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>] <span class="op">*</span> <span class="dv">30</span>,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'date'</span>: pd.date_range(<span class="st">'2024-01-01'</span>, periods<span class="op">=</span><span class="dv">30</span>, freq<span class="op">=</span><span class="st">'D'</span>),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ret'</span>: np.random.randn(<span class="dv">30</span>) <span class="op">*</span> <span class="fl">0.02</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyst forecast updates (irregular)</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>forecasts <span class="op">=</span> pd.DataFrame({</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>] <span class="op">*</span> <span class="dv">5</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'forecast_date'</span>: pd.to_datetime([</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2023-12-15'</span>, <span class="st">'2024-01-05'</span>, <span class="st">'2024-01-12'</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2024-01-20'</span>, <span class="st">'2024-01-28'</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    ]),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'consensus_eps'</span>: [<span class="fl">5.25</span>, <span class="fl">5.30</span>, <span class="fl">5.28</span>, <span class="fl">5.35</span>, <span class="fl">5.40</span>],</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'num_analysts'</span>: [<span class="dv">25</span>, <span class="dv">26</span>, <span class="dv">27</span>, <span class="dv">28</span>, <span class="dv">29</span>]</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Asof join: current forecast as of each date</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> pd.merge_asof(</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    returns.sort_values(<span class="st">'date'</span>),</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    forecasts.sort_values(<span class="st">'forecast_date'</span>),</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'date'</span>,</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'forecast_date'</span>,</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span><span class="st">'ticker'</span>,</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    direction<span class="op">=</span><span class="st">'backward'</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Pattern 3: Bid-ask spreads and trades</strong></p>
<p>Match each trade to the prevailing bid-ask spread (within milliseconds).</p>
<div id="7b34d75d" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Trades (exact timestamps)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>trades <span class="op">=</span> pd.DataFrame({</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'symbol'</span>: [<span class="st">'AAPL'</span>] <span class="op">*</span> <span class="dv">5</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'trade_time'</span>: pd.to_datetime([</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2024-01-02 09:30:00.123'</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2024-01-02 09:30:00.456'</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2024-01-02 09:30:01.789'</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2024-01-02 09:30:02.012'</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2024-01-02 09:30:03.345'</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    ]),</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'trade_price'</span>: [<span class="fl">150.25</span>, <span class="fl">150.26</span>, <span class="fl">150.24</span>, <span class="fl">150.25</span>, <span class="fl">150.27</span>],</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'trade_size'</span>: [<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">150</span>, <span class="dv">300</span>, <span class="dv">250</span>]</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Quote updates (irregular, microsecond timestamps)</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>quotes <span class="op">=</span> pd.DataFrame({</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'symbol'</span>: [<span class="st">'AAPL'</span>] <span class="op">*</span> <span class="dv">4</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'quote_time'</span>: pd.to_datetime([</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2024-01-02 09:30:00.100'</span>,</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2024-01-02 09:30:00.500'</span>,</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2024-01-02 09:30:02.000'</span>,</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2024-01-02 09:30:03.000'</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    ]),</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'bid'</span>: [<span class="fl">150.24</span>, <span class="fl">150.25</span>, <span class="fl">150.23</span>, <span class="fl">150.26</span>],</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ask'</span>: [<span class="fl">150.26</span>, <span class="fl">150.27</span>, <span class="fl">150.25</span>, <span class="fl">150.28</span>]</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Asof join: prevailing quote at each trade</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> pd.merge_asof(</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    trades.sort_values(<span class="st">'trade_time'</span>),</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    quotes.sort_values(<span class="st">'quote_time'</span>),</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'trade_time'</span>,</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'quote_time'</span>,</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    by<span class="op">=</span><span class="st">'symbol'</span>,</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    direction<span class="op">=</span><span class="st">'backward'</span>,</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    tolerance<span class="op">=</span>pd.Timedelta(<span class="st">'1s'</span>),  <span class="co"># Only match within 1 second</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    allow_exact_matches<span class="op">=</span><span class="va">False</span>  <span class="co"># Use quote *before* the trade, not at same instant</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate effective spread</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>merged[<span class="st">'spread'</span>] <span class="op">=</span> merged[<span class="st">'ask'</span>] <span class="op">-</span> merged[<span class="st">'bid'</span>]</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>merged[<span class="st">'effective_spread'</span>] <span class="op">=</span> <span class="bu">abs</span>(merged[<span class="st">'trade_price'</span>] <span class="op">-</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>                                  (merged[<span class="st">'bid'</span>] <span class="op">+</span> merged[<span class="st">'ask'</span>]) <span class="op">/</span> <span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="diagnosing-and-correcting-merge-errors" class="level2" data-number="16.4">
<h2 data-number="16.4" class="anchored" data-anchor-id="diagnosing-and-correcting-merge-errors"><span class="header-section-number">16.4</span> Diagnosing and Correcting Merge Errors</h2>
<p>Merges fail silently. You run the code, get a DataFrame back, and assume it worked. But maybe 80% of rows didn’t match. Maybe you have duplicate keys creating a many-to-many join. Maybe your date formats don’t align. The code runs, but your results are garbage.</p>
<p>Run the following checks every time until they become automatic.</p>
<section id="essential-checks-before-and-after-merging" class="level3" data-number="16.4.1">
<h3 data-number="16.4.1" class="anchored" data-anchor-id="essential-checks-before-and-after-merging"><span class="header-section-number">16.4.1</span> Essential checks before and after merging</h3>
<p><strong>Before merging:</strong></p>
<ul>
<li><strong>Predict row counts</strong>: Inner join should give ≤ min(left, right) rows; left join should preserve left row count for one-to-one or one-to-many; outer join gives ≥ max(left, right) rows</li>
<li><strong>Check for duplicate keys</strong>: Use <code>df.duplicated(key_cols).sum()</code> or <code>validate</code> parameter to enforce cardinality</li>
<li><strong>Verify data types match</strong>: Use <code>df[key_cols].dtypes</code> to ensure join keys have compatible types</li>
<li><strong>For string keys</strong>: Normalize with <code>.str.strip().str.upper()</code> to handle whitespace and case differences</li>
<li><strong>For dates</strong>: Ensure both use <code>datetime64</code>, same time zone, and same granularity</li>
</ul>
<p><strong>After merging:</strong></p>
<ul>
<li><strong>Check row count changes</strong>: Unexpected changes indicate duplicate keys or wrong join type</li>
<li><strong>Check match rates</strong>: Use <code>indicator=True</code> to see how many rows matched (use <code>merged['_merge'].value_counts()</code>)</li>
<li><strong>Inspect missing values</strong>: NaN in right-side columns after left join indicates failed matches</li>
</ul>
</section>
<section id="using-the-indicator-parameter" class="level3" data-number="16.4.2">
<h3 data-number="16.4.2" class="anchored" data-anchor-id="using-the-indicator-parameter"><span class="header-section-number">16.4.2</span> Using the indicator parameter</h3>
<p>The <code>indicator=True</code> parameter adds a <code>_merge</code> column showing match status:</p>
<div id="a21da2ef" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-20"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-20-1"><a href="#annotated-cell-20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-create sample data for merge diagnostics</span></span>
<span id="annotated-cell-20-2"><a href="#annotated-cell-20-2" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> pd.DataFrame({</span>
<span id="annotated-cell-20-3"><a href="#annotated-cell-20-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>, <span class="st">'MSFT'</span>, <span class="st">'TSLA'</span>],</span>
<span id="annotated-cell-20-4"><a href="#annotated-cell-20-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span>: [<span class="dv">2023</span>, <span class="dv">2023</span>, <span class="dv">2023</span>],</span>
<span id="annotated-cell-20-5"><a href="#annotated-cell-20-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'return'</span>: [<span class="fl">0.45</span>, <span class="fl">0.35</span>, <span class="fl">0.10</span>]</span>
<span id="annotated-cell-20-6"><a href="#annotated-cell-20-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="annotated-cell-20-7"><a href="#annotated-cell-20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-20-8"><a href="#annotated-cell-20-8" aria-hidden="true" tabindex="-1"></a>accounting <span class="op">=</span> pd.DataFrame({</span>
<span id="annotated-cell-20-9"><a href="#annotated-cell-20-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>, <span class="st">'TSLA'</span>, <span class="st">'GOOGL'</span>],</span>
<span id="annotated-cell-20-10"><a href="#annotated-cell-20-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'year'</span>: [<span class="dv">2023</span>, <span class="dv">2023</span>, <span class="dv">2023</span>],</span>
<span id="annotated-cell-20-11"><a href="#annotated-cell-20-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'roa'</span>: [<span class="fl">0.20</span>, <span class="fl">0.05</span>, <span class="fl">0.15</span>],</span>
<span id="annotated-cell-20-12"><a href="#annotated-cell-20-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'leverage'</span>: [<span class="fl">0.30</span>, <span class="fl">0.10</span>, <span class="fl">0.05</span>]</span>
<span id="annotated-cell-20-13"><a href="#annotated-cell-20-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="annotated-cell-20-14"><a href="#annotated-cell-20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-20-15"><a href="#annotated-cell-20-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Left join with indicator</span></span>
<span id="annotated-cell-20-16"><a href="#annotated-cell-20-16" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> returns.merge(</span>
<span id="annotated-cell-20-17"><a href="#annotated-cell-20-17" aria-hidden="true" tabindex="-1"></a>    accounting,</span>
<span id="annotated-cell-20-18"><a href="#annotated-cell-20-18" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'year'</span>],</span>
<span id="annotated-cell-20-19"><a href="#annotated-cell-20-19" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="1">1</button><span id="annotated-cell-20-20" class="code-annotation-target"><a href="#annotated-cell-20-20" aria-hidden="true" tabindex="-1"></a>    indicator<span class="op">=</span><span class="va">True</span></span>
<span id="annotated-cell-20-21"><a href="#annotated-cell-20-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-20-22"><a href="#annotated-cell-20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-20-23"><a href="#annotated-cell-20-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Check match rates</span></span>
<span id="annotated-cell-20-24"><a href="#annotated-cell-20-24" aria-hidden="true" tabindex="-1"></a>merged[<span class="st">'_merge'</span>].value_counts()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-20" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="20" data-code-annotation="1">Adds a <code>_merge</code> column showing whether each row matched: <code>left_only</code>, <code>right_only</code>, or <code>both</code>.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>_merge
both          2
left_only     1
right_only    0
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="1745434d" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Match rate: </span><span class="sc">{</span>(merged[<span class="st">'_merge'</span>] <span class="op">==</span> <span class="st">'both'</span>)<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Match rate: 66.7%</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Investigate low match rates
</div>
</div>
<div class="callout-body-container callout-body">
<p>A match rate below 90% usually indicates problems: incorrect join keys, different identifier schemes (CUSIP vs PERMNO), date format mismatches, inconsistent capitalization, or datasets filtered to different subsets. Don’t just accept low match rates—understand why they occurred.</p>
</div>
</div>
</section>
<section id="common-merge-error-patterns" class="level3" data-number="16.4.3">
<h3 data-number="16.4.3" class="anchored" data-anchor-id="common-merge-error-patterns"><span class="header-section-number">16.4.3</span> Common merge error patterns</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 27%">
<col style="width: 21%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>Error</th>
<th>Symptom</th>
<th>Cause</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cartesian explosion</td>
<td>Row count explodes (10,000x+ more rows)</td>
<td>Duplicate keys in both datasets</td>
<td>Aggregate one dataset or use more specific join keys</td>
</tr>
<tr class="even">
<td>Zero matches</td>
<td>All rows are <code>left_only</code></td>
<td>Keys don’t overlap at all</td>
<td>Check identifier mapping (CUSIP vs PERMNO), date formats</td>
</tr>
<tr class="odd">
<td>Type mismatch</td>
<td>Low or zero matches despite overlapping keys</td>
<td>Different data types (int vs float, str vs object)</td>
<td>Convert both to same type before merge</td>
</tr>
<tr class="even">
<td>Float precision</td>
<td>Values that should match don’t</td>
<td><code>150.25</code> vs <code>150.25000001</code></td>
<td>Round floats or use integer keys</td>
</tr>
<tr class="odd">
<td>Time zone mismatch</td>
<td>Asof join produces all NaN</td>
<td>One dataset in UTC, other in local time</td>
<td>Convert both to same time zone</td>
</tr>
<tr class="even">
<td>Case/whitespace</td>
<td>Low matches on string keys</td>
<td>“AAPL” vs “aapl” vs ” AAPL”</td>
<td>Use <code>.str.strip().str.upper()</code></td>
</tr>
<tr class="odd">
<td>Unsorted asof join</td>
<td>Wrong matches or NaN</td>
<td>Data not sorted by time column</td>
<td>Always <code>sort_values()</code> before asof joins</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="summary-and-best-practices" class="level2" data-number="16.5">
<h2 data-number="16.5" class="anchored" data-anchor-id="summary-and-best-practices"><span class="header-section-number">16.5</span> Summary and Best Practices</h2>
<p>Merging is where most data errors occur in empirical finance. Follow these practices to catch problems early:</p>
<ol type="1">
<li><p><strong>Understand cardinality before merging.</strong> Is this one-to-one, one-to-many, or many-to-many? Use <code>validate</code> to enforce expectations.</p></li>
<li><p><strong>Choose the right merge type.</strong> Inner for complete cases only, left to preserve your sample, outer rarely (and carefully).</p></li>
<li><p><strong>Use asof joins for time-series data.</strong> Don’t try to match timestamps exactly—use asof joins with <code>direction='backward'</code> to avoid look-ahead bias.</p></li>
<li><p><strong>Validate every merge.</strong> Check row counts, match rates, duplicates, and data types until these checks become automatic.</p></li>
<li><p><strong>Sort before asof joins.</strong> Unsorted data produces silent errors.</p></li>
<li><p><strong>Document match rates.</strong> Report how many observations matched in your analysis. Low match rates indicate problems.</p></li>
<li><p><strong>Normalize strings.</strong> Strip whitespace, standardize case, remove special characters before merging on text.</p></li>
<li><p><strong>Use indicator columns.</strong> Add <code>indicator=True</code> to understand what matched and what didn’t.</p></li>
<li><p><strong>Prefer left joins for clarity.</strong> Write <code>base.merge(extra, how='left')</code> instead of <code>extra.merge(base, how='right')</code>.</p></li>
<li><p><strong>Consider Polars for large datasets.</strong> Polars’ lazy evaluation and better error messages can save time on big merges.</p></li>
</ol>
<p>The datasets in empirical finance are messy. Companies change tickers, databases use different identifiers, timestamps don’t align. Merging correctly requires skepticism, validation, and careful attention to detail. The techniques in this chapter won’t eliminate merge errors, but they’ll help you catch them before they corrupt your research.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../data-analysis/reshaping/index.html" class="pagination-link" aria-label="Reshaping Data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Reshaping Data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../data-analysis/visualization/index.html" class="pagination-link" aria-label="Data Visualization">
        <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Data Visualization</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://vincentgregoire.com">
<p>© 2026 Vincent Grégoire</p>
</a>
  </li>  
    <li class="nav-item">
  - 
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
<p>Licensed under CC BY-NC-ND 4.0</p>
</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>