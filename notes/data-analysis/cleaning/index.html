<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>13&nbsp; Data Cleaning – Empirical Finance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../data-analysis/structuring/index.html" rel="next">
<link href="../../data-analysis/io/index.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-a074a9bc3144aa89f5d2a8631a82ff09.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script defer="" src="https://umami.vincentgregoire.com/script.js" data-website-id="5c0abb42-9e67-4889-8e30-295fe46e640b">
</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../data-analysis/index.html">Working with Data</a></li><li class="breadcrumb-item"><a href="../../data-analysis/cleaning/index.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Data Cleaning</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Empirical Finance</a> 
        <div class="sidebar-tools-main">
    <a href="../../Empirical-Finance.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About This Book</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../python/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Python</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/install/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Installing Python</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/python-basics/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Python Syntax</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/oop/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Object-Oriented Programming Basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/code-quality/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Code Quality and Documentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/testing/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Error Handling and Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/logging/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Logging and Configuration</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/tools/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Development Environment and Tools</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/git/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Version Control using Git and GitHub</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/ai-for-coding/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Using AI for Coding in Empirical Research</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../python/devcontainers/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Stay Safe with Devcontainers</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../data-analysis/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Working with Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/dataframes/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Introduction to DataFrames</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/io/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Data Input and File Formats</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/cleaning/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Data Cleaning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/structuring/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Data Structuring and Aggregation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/reshaping/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Reshaping Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../data-analysis/joins/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Joins and Merges</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#detecting-and-handling-duplicates" id="toc-detecting-and-handling-duplicates" class="nav-link active" data-scroll-target="#detecting-and-handling-duplicates"><span class="header-section-number">13.1</span> Detecting and Handling Duplicates</a>
  <ul class="collapse">
  <li><a href="#identifying-duplicates" id="toc-identifying-duplicates" class="nav-link" data-scroll-target="#identifying-duplicates"><span class="header-section-number">13.1.1</span> Identifying duplicates</a></li>
  <li><a href="#removing-duplicates" id="toc-removing-duplicates" class="nav-link" data-scroll-target="#removing-duplicates"><span class="header-section-number">13.1.2</span> Removing duplicates</a></li>
  <li><a href="#best-practices-for-duplicate-handling" id="toc-best-practices-for-duplicate-handling" class="nav-link" data-scroll-target="#best-practices-for-duplicate-handling"><span class="header-section-number">13.1.3</span> Best practices for duplicate handling</a></li>
  </ul></li>
  <li><a href="#missing-data-detection-and-imputation" id="toc-missing-data-detection-and-imputation" class="nav-link" data-scroll-target="#missing-data-detection-and-imputation"><span class="header-section-number">13.2</span> Missing Data: Detection and Imputation</a>
  <ul class="collapse">
  <li><a href="#understanding-missing-data-mechanisms" id="toc-understanding-missing-data-mechanisms" class="nav-link" data-scroll-target="#understanding-missing-data-mechanisms"><span class="header-section-number">13.2.1</span> Understanding missing data mechanisms</a></li>
  <li><a href="#detecting-missing-data" id="toc-detecting-missing-data" class="nav-link" data-scroll-target="#detecting-missing-data"><span class="header-section-number">13.2.2</span> Detecting missing data</a></li>
  <li><a href="#handling-missing-data-deletion" id="toc-handling-missing-data-deletion" class="nav-link" data-scroll-target="#handling-missing-data-deletion"><span class="header-section-number">13.2.3</span> Handling missing data: deletion</a></li>
  <li><a href="#handling-missing-data-imputation" id="toc-handling-missing-data-imputation" class="nav-link" data-scroll-target="#handling-missing-data-imputation"><span class="header-section-number">13.2.4</span> Handling missing data: imputation</a></li>
  </ul></li>
  <li><a href="#data-validation" id="toc-data-validation" class="nav-link" data-scroll-target="#data-validation"><span class="header-section-number">13.3</span> Data Validation</a>
  <ul class="collapse">
  <li><a href="#validating-data-types-and-formats" id="toc-validating-data-types-and-formats" class="nav-link" data-scroll-target="#validating-data-types-and-formats"><span class="header-section-number">13.3.1</span> Validating data types and formats</a></li>
  <li><a href="#range-and-constraint-validation" id="toc-range-and-constraint-validation" class="nav-link" data-scroll-target="#range-and-constraint-validation"><span class="header-section-number">13.3.2</span> Range and constraint validation</a></li>
  <li><a href="#detecting-outliers" id="toc-detecting-outliers" class="nav-link" data-scroll-target="#detecting-outliers"><span class="header-section-number">13.3.3</span> Detecting outliers</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../data-analysis/index.html">Working with Data</a></li><li class="breadcrumb-item"><a href="../../data-analysis/cleaning/index.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Data Cleaning</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Data Cleaning</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Data cleaning is one of the most critical and time-consuming steps in any empirical analysis. In finance, working with real-world data means confronting issues like duplicate records, missing observations, data entry errors, and outliers. These problems are not merely technical annoyances—they can lead to incorrect conclusions, flawed trading strategies, or misleading research findings if not handled properly.</p>
<p>The goal of data cleaning is not to make data “perfect” but to make it suitable for analysis. This means understanding the nature of data quality issues, their potential causes, and the trade-offs involved in different cleaning approaches. In this chapter, we will cover the essential techniques for detecting and handling common data quality problems using Python’s main data manipulation libraries: pandas and Polars.</p>
<p>Before we begin, let’s understand an important principle: data cleaning decisions should be <strong>documented</strong> and <strong>reproducible</strong>. Every choice you make—whether to drop duplicates, impute missing values, or remove outliers—affects your results. Your code should clearly show what cleaning steps were taken and why, so that others (including your future self) can understand and validate your approach.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Data Wrangler in VS Code
</div>
</div>
<div class="callout-body-container callout-body">
<p>Microsoft provides a VS Code extension called “Data Wrangler” that provides a nice UI for filtering, cleaning, and transforming data in pandas DataFrames. When done, you can export the Python code to replicate your steps.</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/tSY7wXv5W-Q" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
</div>
</div>
<section id="detecting-and-handling-duplicates" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="detecting-and-handling-duplicates"><span class="header-section-number">13.1</span> Detecting and Handling Duplicates</h2>
<p>Duplicate records are a common problem in financial datasets. They can arise from multiple sources: data feed errors that transmit the same trade twice, mistakes in data aggregation where the same record appears in multiple files, or simple human error in manual data entry. Duplicates are particularly problematic because they can distort statistical analyses, inflate trading volumes, and create artificial patterns in the data.</p>
<section id="identifying-duplicates" class="level3" data-number="13.1.1">
<h3 data-number="13.1.1" class="anchored" data-anchor-id="identifying-duplicates"><span class="header-section-number">13.1.1</span> Identifying duplicates</h3>
<p>The first step in handling duplicates is identifying them. A duplicate can be defined in different ways depending on your data structure and business context.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Types of duplicates
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><strong>Complete duplicates</strong>: All columns have identical values</li>
<li><strong>Partial duplicates</strong>: Only certain key columns are identical (e.g., same date and ticker, but different price)</li>
<li><strong>Near duplicates</strong>: Values are very similar but not exactly identical (often due to floating-point precision)</li>
</ol>
<p>The appropriate definition depends on your data and use case.</p>
</div>
</div>
<p>Let’s start with a simple example using stock price data:</p>
<div id="ae76d4d3" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-1"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-1-1"><a href="#annotated-cell-1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="annotated-cell-1-2"><a href="#annotated-cell-1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="annotated-cell-1-3"><a href="#annotated-cell-1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="annotated-cell-1-4"><a href="#annotated-cell-1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-5"><a href="#annotated-cell-1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sample stock price data with duplicates</span></span>
<span id="annotated-cell-1-6"><a href="#annotated-cell-1-6" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> pd.date_range(<span class="st">'2024-01-01'</span>, periods<span class="op">=</span><span class="dv">5</span>, freq<span class="op">=</span><span class="st">'D'</span>)</span>
<span id="annotated-cell-1-7"><a href="#annotated-cell-1-7" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="1">1</button><span id="annotated-cell-1-8" class="code-annotation-target"><a href="#annotated-cell-1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'date'</span>: <span class="bu">list</span>(dates) <span class="op">+</span> [dates[<span class="dv">2</span>]],  <span class="co"># Duplicate date</span></span>
<span id="annotated-cell-1-9"><a href="#annotated-cell-1-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>, <span class="st">'AAPL'</span>, <span class="st">'AAPL'</span>, <span class="st">'AAPL'</span>, <span class="st">'AAPL'</span>, <span class="st">'AAPL'</span>],</span>
<span id="annotated-cell-1-10"><a href="#annotated-cell-1-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'price'</span>: [<span class="fl">150.0</span>, <span class="fl">152.5</span>, <span class="fl">155.0</span>, <span class="fl">153.0</span>, <span class="fl">157.0</span>, <span class="fl">155.0</span>],</span>
<span id="annotated-cell-1-11"><a href="#annotated-cell-1-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'volume'</span>: [<span class="dv">1000000</span>, <span class="dv">1100000</span>, <span class="dv">1200000</span>, <span class="dv">950000</span>, <span class="dv">1300000</span>, <span class="dv">1200000</span>]</span>
<span id="annotated-cell-1-12"><a href="#annotated-cell-1-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-1-13"><a href="#annotated-cell-1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-1-14"><a href="#annotated-cell-1-14" aria-hidden="true" tabindex="-1"></a>df_pd <span class="op">=</span> pd.DataFrame(data)</span>
<span id="annotated-cell-1-15"><a href="#annotated-cell-1-15" aria-hidden="true" tabindex="-1"></a>df_pd</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-1" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="8" data-code-annotation="1">Adding a duplicate of the third date to create a duplicate record.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.5</td>
<td>1100000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.0</td>
<td>1200000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.0</td>
<td>950000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.0</td>
<td>1300000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.0</td>
<td>1200000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now let’s detect duplicates. The <code>duplicated()</code> method returns a boolean Series indicating which rows are duplicates:</p>
<div id="0ef49d9d" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for complete duplicates</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>df_pd.duplicated()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>0    False
1    False
2    False
3    False
4    False
5     True
dtype: bool</code></pre>
</div>
</div>
<p>We can also check for duplicates based on specific columns:</p>
<div id="3bd62a7c" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates based on specific columns (date and ticker)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df_pd.duplicated(subset<span class="op">=</span>[<span class="st">'date'</span>, <span class="st">'ticker'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>0    False
1    False
2    False
3    False
4    False
5     True
dtype: bool</code></pre>
</div>
</div>
<p>To see which rows are duplicates, we can filter the DataFrame:</p>
<div id="fcce9a1a" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># See which rows are duplicates (keep=False marks all duplicates)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df_pd[df_pd.duplicated(subset<span class="op">=</span>[<span class="st">'date'</span>, <span class="st">'ticker'</span>], keep<span class="op">=</span><span class="va">False</span>)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.0</td>
<td>1200000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.0</td>
<td>1200000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The <code>keep</code> parameter controls which duplicate to mark:</p>
<ul>
<li><code>keep='first'</code> (default): Mark all duplicates as <code>True</code> except the first occurrence</li>
<li><code>keep='last'</code>: Mark all duplicates as <code>True</code> except the last occurrence</li>
<li><code>keep=False</code>: Mark all duplicates as <code>True</code>, including the first occurrence</li>
</ul>
<p>Now let’s see the same operations in Polars:</p>
<div id="dc7431cf" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df_pl <span class="op">=</span> pl.DataFrame(data)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>df_pl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (6, 4)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
</tr>
<tr class="even">
<td>datetime[μs]</td>
<td>str</td>
<td>f64</td>
<td>i64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-01 00:00:00</td>
<td>"AAPL"</td>
<td>150.0</td>
<td>1000000</td>
</tr>
<tr class="even">
<td>2024-01-02 00:00:00</td>
<td>"AAPL"</td>
<td>152.5</td>
<td>1100000</td>
</tr>
<tr class="odd">
<td>2024-01-03 00:00:00</td>
<td>"AAPL"</td>
<td>155.0</td>
<td>1200000</td>
</tr>
<tr class="even">
<td>2024-01-04 00:00:00</td>
<td>"AAPL"</td>
<td>153.0</td>
<td>950000</td>
</tr>
<tr class="odd">
<td>2024-01-05 00:00:00</td>
<td>"AAPL"</td>
<td>157.0</td>
<td>1300000</td>
</tr>
<tr class="even">
<td>2024-01-03 00:00:00</td>
<td>"AAPL"</td>
<td>155.0</td>
<td>1200000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>To find duplicates in Polars, we use <code>is_duplicated()</code>:</p>
<div id="19b77e38" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicates based on date and ticker</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>df_pl.<span class="bu">filter</span>(pl.struct([<span class="st">'date'</span>, <span class="st">'ticker'</span>]).is_duplicated())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (2, 4)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
</tr>
<tr class="even">
<td>datetime[μs]</td>
<td>str</td>
<td>f64</td>
<td>i64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-03 00:00:00</td>
<td>"AAPL"</td>
<td>155.0</td>
<td>1200000</td>
</tr>
<tr class="even">
<td>2024-01-03 00:00:00</td>
<td>"AAPL"</td>
<td>155.0</td>
<td>1200000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="removing-duplicates" class="level3" data-number="13.1.2">
<h3 data-number="13.1.2" class="anchored" data-anchor-id="removing-duplicates"><span class="header-section-number">13.1.2</span> Removing duplicates</h3>
<p>Once we’ve identified duplicates, we need to decide how to handle them. The most common approaches are:</p>
<ol type="1">
<li><strong>Drop all duplicates</strong>: Keep only the first (or last) occurrence</li>
<li><strong>Aggregate duplicates</strong>: Combine duplicate rows using aggregation (e.g., average prices)</li>
<li><strong>Manual investigation</strong>: For small numbers of duplicates, inspect each case individually</li>
</ol>
<p>Let’s see how to implement these approaches. In pandas, we use <code>drop_duplicates()</code>:</p>
<div id="734cc982" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pandas: Drop duplicates, keeping first occurrence</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>df_pd_clean <span class="op">=</span> df_pd.drop_duplicates(subset<span class="op">=</span>[<span class="st">'date'</span>, <span class="st">'ticker'</span>], keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>df_pd_clean</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.5</td>
<td>1100000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.0</td>
<td>1200000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.0</td>
<td>950000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.0</td>
<td>1300000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In Polars, we use the <code>unique()</code> method:</p>
<div id="a4e948da" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Polars: Drop duplicates</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>df_pl_clean <span class="op">=</span> df_pl.unique(subset<span class="op">=</span>[<span class="st">'date'</span>, <span class="st">'ticker'</span>], keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>df_pl_clean</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (5, 4)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
</tr>
<tr class="even">
<td>datetime[μs]</td>
<td>str</td>
<td>f64</td>
<td>i64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-03 00:00:00</td>
<td>"AAPL"</td>
<td>155.0</td>
<td>1200000</td>
</tr>
<tr class="even">
<td>2024-01-04 00:00:00</td>
<td>"AAPL"</td>
<td>153.0</td>
<td>950000</td>
</tr>
<tr class="odd">
<td>2024-01-01 00:00:00</td>
<td>"AAPL"</td>
<td>150.0</td>
<td>1000000</td>
</tr>
<tr class="even">
<td>2024-01-02 00:00:00</td>
<td>"AAPL"</td>
<td>152.5</td>
<td>1100000</td>
</tr>
<tr class="odd">
<td>2024-01-05 00:00:00</td>
<td>"AAPL"</td>
<td>157.0</td>
<td>1300000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>For the aggregation approach, suppose we want to take the average price and total volume when duplicates exist:</p>
<div id="0d422b35" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pandas: Aggregate duplicates</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>df_pd_agg <span class="op">=</span> df_pd.groupby([<span class="st">'date'</span>, <span class="st">'ticker'</span>], as_index<span class="op">=</span><span class="va">False</span>).agg({</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'price'</span>: <span class="st">'mean'</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'volume'</span>: <span class="st">'sum'</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>df_pd_agg</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.5</td>
<td>1100000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.0</td>
<td>2400000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.0</td>
<td>950000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.0</td>
<td>1300000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="efd37773" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Polars: Aggregate duplicates</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>df_pl_agg <span class="op">=</span> df_pl.group_by([<span class="st">'date'</span>, <span class="st">'ticker'</span>]).agg([</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'price'</span>).mean(),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'volume'</span>).<span class="bu">sum</span>()</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>df_pl_agg</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (5, 4)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
</tr>
<tr class="even">
<td>datetime[μs]</td>
<td>str</td>
<td>f64</td>
<td>i64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-01 00:00:00</td>
<td>"AAPL"</td>
<td>150.0</td>
<td>1000000</td>
</tr>
<tr class="even">
<td>2024-01-03 00:00:00</td>
<td>"AAPL"</td>
<td>155.0</td>
<td>2400000</td>
</tr>
<tr class="odd">
<td>2024-01-05 00:00:00</td>
<td>"AAPL"</td>
<td>157.0</td>
<td>1300000</td>
</tr>
<tr class="even">
<td>2024-01-02 00:00:00</td>
<td>"AAPL"</td>
<td>152.5</td>
<td>1100000</td>
</tr>
<tr class="odd">
<td>2024-01-04 00:00:00</td>
<td>"AAPL"</td>
<td>153.0</td>
<td>950000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Common pitfall: implicit duplicates
</div>
</div>
<div class="callout-body-container callout-body">
<p>Be careful about duplicates that arise from data structure decisions. For example, if you merge two datasets and accidentally create a many-to-many join, you may generate duplicates without realizing it. Always check the row count before and after joins to ensure you haven’t inadvertently created duplicates. We discuss joins in detail in <a href="../joins/index.html" class="quarto-xref"><span>Chapter 16</span></a>.</p>
</div>
</div>
</section>
<section id="best-practices-for-duplicate-handling" class="level3" data-number="13.1.3">
<h3 data-number="13.1.3" class="anchored" data-anchor-id="best-practices-for-duplicate-handling"><span class="header-section-number">13.1.3</span> Best practices for duplicate handling</h3>
<ol type="1">
<li><strong>Always investigate before removing</strong>: Look at a sample of duplicates to understand why they exist</li>
<li><strong>Document your decisions</strong>: Add comments explaining which columns define a duplicate and why</li>
<li><strong>Keep track of removals</strong>: Log how many duplicates you removed and their characteristics</li>
<li><strong>Consider the source</strong>: Different data sources may have different duplicate patterns</li>
</ol>
<div id="428fbcf8" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Comprehensive duplicate handling with logging</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> handle_duplicates(df, subset_cols, keep<span class="op">=</span><span class="st">'first'</span>, verbose<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Remove duplicates with logging.</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">        Input dataframe</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">    subset_cols : list</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Columns that define a duplicate</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">    keep : str</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Which duplicate to keep ('first', 'last', or False)</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">    verbose : bool</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Whether to print diagnostic information</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Cleaned dataframe</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    initial_rows <span class="op">=</span> <span class="bu">len</span>(df)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    duplicated_mask <span class="op">=</span> df.duplicated(subset<span class="op">=</span>subset_cols, keep<span class="op">=</span>keep)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    n_duplicates <span class="op">=</span> duplicated_mask.<span class="bu">sum</span>()</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose:</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Initial rows: </span><span class="sc">{</span>initial_rows<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Duplicates found: </span><span class="sc">{</span>n_duplicates<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n_duplicates <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Duplicate rows (sample):"</span>)</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(df[duplicated_mask].head())</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    df_clean <span class="op">=</span> df[<span class="op">~</span>duplicated_mask].copy()</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose:</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Final rows: </span><span class="sc">{</span><span class="bu">len</span>(df_clean)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Rows removed: </span><span class="sc">{</span>initial_rows <span class="op">-</span> <span class="bu">len</span>(df_clean)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_clean</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the function</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>df_cleaned <span class="op">=</span> handle_duplicates(df_pd, subset_cols<span class="op">=</span>[<span class="st">'date'</span>, <span class="st">'ticker'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Initial rows: 6
Duplicates found: 1
Duplicate rows (sample):
        date ticker  price   volume
5 2024-01-03   AAPL  155.0  1200000
Final rows: 5
Rows removed: 1</code></pre>
</div>
</div>
</section>
</section>
<section id="missing-data-detection-and-imputation" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="missing-data-detection-and-imputation"><span class="header-section-number">13.2</span> Missing Data: Detection and Imputation</h2>
<p>Missing data is ubiquitous in financial datasets. Stock markets close on holidays, companies report earnings quarterly but not daily, economic indicators are released with delays, and data collection systems occasionally fail. How you handle missing data can significantly impact your analysis, and there is rarely a single “correct” approach.</p>
<section id="understanding-missing-data-mechanisms" class="level3" data-number="13.2.1">
<h3 data-number="13.2.1" class="anchored" data-anchor-id="understanding-missing-data-mechanisms"><span class="header-section-number">13.2.1</span> Understanding missing data mechanisms</h3>
<p>Before deciding how to handle missing data, it’s important to understand why data might be missing. Statisticians classify missing data into three categories:</p>
<ol type="1">
<li><p><strong>Missing Completely at Random (MCAR)</strong>: The probability that a value is missing is unrelated to any observed or unobserved data. For example, if a data feed randomly drops 1% of all observations due to network issues, the missing data is MCAR.</p></li>
<li><p><strong>Missing at Random (MAR)</strong>: The probability that a value is missing depends on observed data but not on the missing value itself. For example, small-cap stocks might have more missing volume data than large-cap stocks, but conditional on market cap, the missingness is random.</p></li>
<li><p><strong>Missing Not at Random (MNAR)</strong>: The probability that a value is missing depends on the missing value itself. For example, companies might be less likely to report earnings when performance is poor, or traders might fail to report large losses.</p></li>
</ol>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Why this matters
</div>
</div>
<div class="callout-body-container callout-body">
<p>The type of missingness affects which imputation methods are valid. MCAR is the easiest to handle (you can often just drop missing observations), while MNAR is the most problematic because missing data itself carries information. Unfortunately, in real financial data, you often cannot definitively determine which mechanism is operating, so you need to think carefully about the context.</p>
</div>
</div>
</section>
<section id="detecting-missing-data" class="level3" data-number="13.2.2">
<h3 data-number="13.2.2" class="anchored" data-anchor-id="detecting-missing-data"><span class="header-section-number">13.2.2</span> Detecting missing data</h3>
<p>Python uses different representations for missing data depending on the data type:</p>
<ul>
<li><strong><code>NaN</code></strong> (Not a Number): Used for missing floating-point values</li>
<li><strong><code>None</code></strong>: Python’s built-in null value</li>
<li><strong><code>NaT</code></strong> (Not a Time): Used for missing datetime values</li>
<li><strong><code>pd.NA</code></strong>: pandas’ new missing indicator for all dtypes</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Historical context: missing values in pandas
</div>
</div>
<div class="callout-body-container callout-body">
<p>Initially, pandas used NumPy as its backend and could not represent missing values explicitly. Instead, it used <code>NaN</code> for floats and <code>None</code> (a Python object) for strings. This approach had important limitations:</p>
<ol type="1">
<li><p>For integers, pandas would first convert all values in the column to float and use <code>NaN</code> to represent missing values. This meant you couldn’t have a truly integer column with missing values.</p></li>
<li><p><code>NaN</code> has a specific meaning in floating-point arithmetic: it represents a value that is “not a number,” such as the result of an undefined operation (e.g., <code>log(-1)</code>). Reusing <code>NaN</code> to mean “missing” conflates two distinct concepts and complicates handling of true <code>NaN</code> results.</p></li>
</ol>
<p>Polars and newer backends for pandas (such as PyArrow) explicitly support missing data indicators for all column types, avoiding these limitations.</p>
</div>
</div>
<p>Let’s create a dataset with missing values:</p>
<div id="a9156775" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>data_missing <span class="op">=</span> {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'date'</span>: pd.date_range(<span class="st">'2024-01-01'</span>, periods<span class="op">=</span><span class="dv">10</span>, freq<span class="op">=</span><span class="st">'D'</span>),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>] <span class="op">*</span> <span class="dv">10</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'price'</span>: [<span class="fl">150.0</span>, <span class="fl">152.5</span>, np.nan, <span class="fl">153.0</span>, <span class="fl">157.0</span>, np.nan, <span class="fl">159.0</span>, <span class="fl">158.5</span>, np.nan, <span class="fl">161.0</span>],</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'volume'</span>: [<span class="dv">1000000</span>, np.nan, <span class="dv">1200000</span>, <span class="dv">950000</span>, np.nan, <span class="dv">1100000</span>, <span class="dv">1300000</span>, np.nan, <span class="dv">1250000</span>, <span class="dv">1400000</span>],</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'dividend'</span>: [<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.25</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>]</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>df_missing <span class="op">=</span> pd.DataFrame(data_missing)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>df_missing</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.5</td>
<td>NaN</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>NaN</td>
<td>1200000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.0</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.0</td>
<td>NaN</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>NaN</td>
<td>1100000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-07</td>
<td>AAPL</td>
<td>159.0</td>
<td>1300000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-08</td>
<td>AAPL</td>
<td>158.5</td>
<td>NaN</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-09</td>
<td>AAPL</td>
<td>NaN</td>
<td>1250000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-10</td>
<td>AAPL</td>
<td>161.0</td>
<td>1400000.0</td>
<td>0.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now let’s detect missing values. The <code>isna()</code> method returns a boolean DataFrame indicating which values are missing:</p>
<div id="e45b53d3" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df_missing.isna()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can count missing values per column:</p>
<div id="bf30d778" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df_missing.isna().<span class="bu">sum</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>date        0
ticker      0
price       3
volume      3
dividend    0
dtype: int64</code></pre>
</div>
</div>
<p>Or calculate the percentage of missing values:</p>
<div id="036bd845" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>df_missing.isna().mean() <span class="op">*</span> <span class="dv">100</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>date         0.0
ticker       0.0
price       30.0
volume      30.0
dividend     0.0
dtype: float64</code></pre>
</div>
</div>
<p>To see rows with any missing values:</p>
<div id="ccd9bb96" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df_missing[df_missing.isna().<span class="bu">any</span>(axis<span class="op">=</span><span class="dv">1</span>)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.5</td>
<td>NaN</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>NaN</td>
<td>1200000.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.0</td>
<td>NaN</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>NaN</td>
<td>1100000.0</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-08</td>
<td>AAPL</td>
<td>158.5</td>
<td>NaN</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-09</td>
<td>AAPL</td>
<td>NaN</td>
<td>1250000.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In Polars, we use <code>null_count()</code> to count missing values:</p>
<div id="10b6e765" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Polars version - convert from pandas DataFrame</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (Polars uses None/null for missing values, not np.nan)</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>df_missing_pl <span class="op">=</span> pl.from_pandas(df_missing)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>df_missing_pl.null_count()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (1, 5)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
<tr class="even">
<td>u32</td>
<td>u32</td>
<td>u32</td>
<td>u32</td>
<td>u32</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0</td>
<td>3</td>
<td>3</td>
<td>0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>We can filter rows with missing values in a specific column:</p>
<div id="9c57c848" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df_missing_pl.<span class="bu">filter</span>(pl.col(<span class="st">'price'</span>).is_null())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (3, 5)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
<tr class="even">
<td>datetime[ns]</td>
<td>str</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-03 00:00:00</td>
<td>"AAPL"</td>
<td>null</td>
<td>1.2e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-06 00:00:00</td>
<td>"AAPL"</td>
<td>null</td>
<td>1.1e6</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>2024-01-09 00:00:00</td>
<td>"AAPL"</td>
<td>null</td>
<td>1.25e6</td>
<td>0.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="handling-missing-data-deletion" class="level3" data-number="13.2.3">
<h3 data-number="13.2.3" class="anchored" data-anchor-id="handling-missing-data-deletion"><span class="header-section-number">13.2.3</span> Handling missing data: deletion</h3>
<p>The simplest approach to missing data is to delete it. There are two main strategies:</p>
<ol type="1">
<li><p><strong>Listwise deletion</strong> (complete case analysis): Rows with any missing values are completely dropped from the sample, so they are not used in any calculation or analysis. This approach is simple and ensures consistency across analyses, but can significantly reduce sample size if missingness is widespread.</p></li>
<li><p><strong>Pairwise deletion</strong>: For each calculation or analysis (e.g., for each regression), use all observations for which we have the required variables. This approach maximizes the use of available data but can lead to different sample sizes for different analyses, making comparisons difficult.</p></li>
</ol>
<p>Listwise deletion removes any row with missing values:</p>
<div id="1ee41924" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df_complete <span class="op">=</span> df_missing.dropna()</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>df_complete</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.0</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-07</td>
<td>AAPL</td>
<td>159.0</td>
<td>1300000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-10</td>
<td>AAPL</td>
<td>161.0</td>
<td>1400000.0</td>
<td>0.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="33f016fc" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rows removed: </span><span class="sc">{</span><span class="bu">len</span>(df_missing) <span class="op">-</span> <span class="bu">len</span>(df_complete)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows removed: 6</code></pre>
</div>
</div>
<p>We can also drop rows only if specific columns are missing:</p>
<div id="9ef4a39b" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df_price_complete <span class="op">=</span> df_missing.dropna(subset<span class="op">=</span>[<span class="st">'price'</span>])</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>df_price_complete</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.5</td>
<td>NaN</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.0</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.0</td>
<td>NaN</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-07</td>
<td>AAPL</td>
<td>159.0</td>
<td>1300000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-08</td>
<td>AAPL</td>
<td>158.5</td>
<td>NaN</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-10</td>
<td>AAPL</td>
<td>161.0</td>
<td>1400000.0</td>
<td>0.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Or drop columns with any missing values:</p>
<div id="530b67cf" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df_no_missing_cols <span class="op">=</span> df_missing.dropna(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>df_no_missing_cols</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>0.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-07</td>
<td>AAPL</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-08</td>
<td>AAPL</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-09</td>
<td>AAPL</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-10</td>
<td>AAPL</td>
<td>0.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In Polars, we use <code>drop_nulls()</code>:</p>
<div id="ff06e424" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df_complete_pl <span class="op">=</span> df_missing_pl.drop_nulls()</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>df_complete_pl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (4, 5)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
<tr class="even">
<td>datetime[ns]</td>
<td>str</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-01 00:00:00</td>
<td>"AAPL"</td>
<td>150.0</td>
<td>1e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-04 00:00:00</td>
<td>"AAPL"</td>
<td>153.0</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="odd">
<td>2024-01-07 00:00:00</td>
<td>"AAPL"</td>
<td>159.0</td>
<td>1.3e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-10 00:00:00</td>
<td>"AAPL"</td>
<td>161.0</td>
<td>1.4e6</td>
<td>0.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="a2a0edce" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows with null in specific column</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>df_price_complete_pl <span class="op">=</span> df_missing_pl.drop_nulls(subset<span class="op">=</span>[<span class="st">'price'</span>])</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>df_price_complete_pl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (7, 5)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
<tr class="even">
<td>datetime[ns]</td>
<td>str</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-01 00:00:00</td>
<td>"AAPL"</td>
<td>150.0</td>
<td>1e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-02 00:00:00</td>
<td>"AAPL"</td>
<td>152.5</td>
<td>null</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>2024-01-04 00:00:00</td>
<td>"AAPL"</td>
<td>153.0</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="even">
<td>2024-01-05 00:00:00</td>
<td>"AAPL"</td>
<td>157.0</td>
<td>null</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>2024-01-07 00:00:00</td>
<td>"AAPL"</td>
<td>159.0</td>
<td>1.3e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-08 00:00:00</td>
<td>"AAPL"</td>
<td>158.5</td>
<td>null</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>2024-01-10 00:00:00</td>
<td>"AAPL"</td>
<td>161.0</td>
<td>1.4e6</td>
<td>0.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>When deletion is problematic
</div>
</div>
<div class="callout-body-container callout-body">
<p>Deletion can introduce bias if:</p>
<ul>
<li>You lose a large percentage of your data</li>
<li>Missingness is not random (MAR or MNAR)</li>
<li>Missing data occurs in key variables</li>
</ul>
<p>In time series analysis, deleting observations can break the temporal structure of your data. Use deletion cautiously and always check how much data you’re losing.</p>
</div>
</div>
</section>
<section id="handling-missing-data-imputation" class="level3" data-number="13.2.4">
<h3 data-number="13.2.4" class="anchored" data-anchor-id="handling-missing-data-imputation"><span class="header-section-number">13.2.4</span> Handling missing data: imputation</h3>
<p>Imputation means filling in missing values with plausible estimates. There are many imputation strategies, each with different assumptions and use cases.</p>
<section id="simple-imputation-methods" class="level4" data-number="13.2.4.1">
<h4 data-number="13.2.4.1" class="anchored" data-anchor-id="simple-imputation-methods"><span class="header-section-number">13.2.4.1</span> Simple imputation methods</h4>
<ol type="1">
<li><strong>Forward fill</strong>: Use the last observed value</li>
<li><strong>Backward fill</strong>: Use the next observed value</li>
<li><strong>Mean/median imputation</strong>: Replace with the column mean or median</li>
<li><strong>Zero/constant imputation</strong>: Replace with zero or another constant</li>
</ol>
<p>In empirical finance, we usually want to avoid introducing look-ahead bias or imputing information that was not available at the time of observation. For this reason, forward fill and zero/constant imputation are the most commonly used imputation methods in financial research.</p>
<p>Forward fill uses the last observed value:</p>
<div id="ec35084e" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df_ffill <span class="op">=</span> df_missing.copy()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>df_ffill[[<span class="st">'price'</span>, <span class="st">'volume'</span>]] <span class="op">=</span> df_ffill[[<span class="st">'price'</span>, <span class="st">'volume'</span>]].ffill()</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>df_ffill</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.5</td>
<td>1000000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>152.5</td>
<td>1200000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.0</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.0</td>
<td>950000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>157.0</td>
<td>1100000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-07</td>
<td>AAPL</td>
<td>159.0</td>
<td>1300000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-08</td>
<td>AAPL</td>
<td>158.5</td>
<td>1300000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-09</td>
<td>AAPL</td>
<td>158.5</td>
<td>1250000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-10</td>
<td>AAPL</td>
<td>161.0</td>
<td>1400000.0</td>
<td>0.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Backward fill uses the next observed value:</p>
<div id="018ff113" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df_bfill <span class="op">=</span> df_missing.copy()</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>df_bfill[[<span class="st">'price'</span>, <span class="st">'volume'</span>]] <span class="op">=</span> df_bfill[[<span class="st">'price'</span>, <span class="st">'volume'</span>]].bfill()</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>df_bfill</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.5</td>
<td>1200000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>153.0</td>
<td>1200000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.0</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.0</td>
<td>1100000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>159.0</td>
<td>1100000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-07</td>
<td>AAPL</td>
<td>159.0</td>
<td>1300000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-08</td>
<td>AAPL</td>
<td>158.5</td>
<td>1250000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-09</td>
<td>AAPL</td>
<td>161.0</td>
<td>1250000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-10</td>
<td>AAPL</td>
<td>161.0</td>
<td>1400000.0</td>
<td>0.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Mean imputation replaces missing values with the column mean:</p>
<div id="5980417f" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df_mean <span class="op">=</span> df_missing.copy()</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>df_mean[<span class="st">'price'</span>] <span class="op">=</span> df_mean[<span class="st">'price'</span>].fillna(df_mean[<span class="st">'price'</span>].mean())</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>df_mean[<span class="st">'volume'</span>] <span class="op">=</span> df_mean[<span class="st">'volume'</span>].fillna(df_mean[<span class="st">'volume'</span>].mean())</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>df_mean</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.000000</td>
<td>1.000000e+06</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.500000</td>
<td>1.171429e+06</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.857143</td>
<td>1.200000e+06</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.000000</td>
<td>9.500000e+05</td>
<td>0.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.000000</td>
<td>1.171429e+06</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>155.857143</td>
<td>1.100000e+06</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-07</td>
<td>AAPL</td>
<td>159.000000</td>
<td>1.300000e+06</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-08</td>
<td>AAPL</td>
<td>158.500000</td>
<td>1.171429e+06</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-09</td>
<td>AAPL</td>
<td>155.857143</td>
<td>1.250000e+06</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-10</td>
<td>AAPL</td>
<td>161.000000</td>
<td>1.400000e+06</td>
<td>0.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Median imputation is more robust to outliers:</p>
<div id="93b68a03" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df_median <span class="op">=</span> df_missing.copy()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>df_median[<span class="st">'price'</span>] <span class="op">=</span> df_median[<span class="st">'price'</span>].fillna(df_median[<span class="st">'price'</span>].median())</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>df_median[<span class="st">'volume'</span>] <span class="op">=</span> df_median[<span class="st">'volume'</span>].fillna(df_median[<span class="st">'volume'</span>].median())</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>df_median</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.5</td>
<td>1200000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>157.0</td>
<td>1200000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.0</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.0</td>
<td>1200000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>157.0</td>
<td>1100000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-07</td>
<td>AAPL</td>
<td>159.0</td>
<td>1300000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-08</td>
<td>AAPL</td>
<td>158.5</td>
<td>1200000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-09</td>
<td>AAPL</td>
<td>157.0</td>
<td>1250000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-10</td>
<td>AAPL</td>
<td>161.0</td>
<td>1400000.0</td>
<td>0.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Constant value imputation:</p>
<div id="409b5495" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>df_zero <span class="op">=</span> df_missing.copy()</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>df_zero[<span class="st">'dividend'</span>] <span class="op">=</span> df_zero[<span class="st">'dividend'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>df_zero</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.5</td>
<td>NaN</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>NaN</td>
<td>1200000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.0</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.0</td>
<td>NaN</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>NaN</td>
<td>1100000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-07</td>
<td>AAPL</td>
<td>159.0</td>
<td>1300000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-08</td>
<td>AAPL</td>
<td>158.5</td>
<td>NaN</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-09</td>
<td>AAPL</td>
<td>NaN</td>
<td>1250000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-10</td>
<td>AAPL</td>
<td>161.0</td>
<td>1400000.0</td>
<td>0.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In Polars, we use <code>forward_fill()</code> and <code>fill_null()</code>:</p>
<div id="67492b95" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>df_ffill_pl <span class="op">=</span> df_missing_pl.select([</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'date'</span>),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'ticker'</span>),</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'price'</span>).forward_fill(),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'volume'</span>).forward_fill(),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'dividend'</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>df_ffill_pl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 5)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
<tr class="even">
<td>datetime[ns]</td>
<td>str</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-01 00:00:00</td>
<td>"AAPL"</td>
<td>150.0</td>
<td>1e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-02 00:00:00</td>
<td>"AAPL"</td>
<td>152.5</td>
<td>1e6</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>2024-01-03 00:00:00</td>
<td>"AAPL"</td>
<td>152.5</td>
<td>1.2e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-04 00:00:00</td>
<td>"AAPL"</td>
<td>153.0</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="odd">
<td>2024-01-05 00:00:00</td>
<td>"AAPL"</td>
<td>157.0</td>
<td>950000.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-06 00:00:00</td>
<td>"AAPL"</td>
<td>157.0</td>
<td>1.1e6</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>2024-01-07 00:00:00</td>
<td>"AAPL"</td>
<td>159.0</td>
<td>1.3e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-08 00:00:00</td>
<td>"AAPL"</td>
<td>158.5</td>
<td>1.3e6</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>2024-01-09 00:00:00</td>
<td>"AAPL"</td>
<td>158.5</td>
<td>1.25e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-10 00:00:00</td>
<td>"AAPL"</td>
<td>161.0</td>
<td>1.4e6</td>
<td>0.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="448f291f" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Polars mean imputation</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>mean_price <span class="op">=</span> df_missing_pl[<span class="st">'price'</span>].mean()</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>mean_volume <span class="op">=</span> df_missing_pl[<span class="st">'volume'</span>].mean()</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>df_mean_pl <span class="op">=</span> df_missing_pl.with_columns([</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'price'</span>).fill_null(mean_price),</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'volume'</span>).fill_null(mean_volume)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>df_mean_pl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (10, 5)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
<tr class="even">
<td>datetime[ns]</td>
<td>str</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-01 00:00:00</td>
<td>"AAPL"</td>
<td>150.0</td>
<td>1e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-02 00:00:00</td>
<td>"AAPL"</td>
<td>152.5</td>
<td>1.1714e6</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>2024-01-03 00:00:00</td>
<td>"AAPL"</td>
<td>155.857143</td>
<td>1.2e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-04 00:00:00</td>
<td>"AAPL"</td>
<td>153.0</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="odd">
<td>2024-01-05 00:00:00</td>
<td>"AAPL"</td>
<td>157.0</td>
<td>1.1714e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-06 00:00:00</td>
<td>"AAPL"</td>
<td>155.857143</td>
<td>1.1e6</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>2024-01-07 00:00:00</td>
<td>"AAPL"</td>
<td>159.0</td>
<td>1.3e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-08 00:00:00</td>
<td>"AAPL"</td>
<td>158.5</td>
<td>1.1714e6</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td>2024-01-09 00:00:00</td>
<td>"AAPL"</td>
<td>155.857143</td>
<td>1.25e6</td>
<td>0.0</td>
</tr>
<tr class="even">
<td>2024-01-10 00:00:00</td>
<td>"AAPL"</td>
<td>161.0</td>
<td>1.4e6</td>
<td>0.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Choosing an imputation method for financial data
</div>
</div>
<div class="callout-body-container callout-body">
<p>The appropriate method depends on your data and context:</p>
<ul>
<li><strong>Forward fill</strong>: Good for prices and slowly-changing variables (assumes last observation is still valid)</li>
<li><strong>Mean/median</strong>: Reasonable for cross-sectional data, but can distort distributions and relationships</li>
<li><strong>Zero</strong>: Appropriate when zero is a meaningful value (e.g., dividends, corporate actions)</li>
<li><strong>Interpolation</strong>: Useful when you expect smooth changes over time</li>
</ul>
<p>Never use imputation blindly—think about what each method assumes about your data.</p>
</div>
</div>
</section>
<section id="linear-interpolation" class="level4" data-number="13.2.4.2">
<h4 data-number="13.2.4.2" class="anchored" data-anchor-id="linear-interpolation"><span class="header-section-number">13.2.4.2</span> Linear interpolation</h4>
<p>For time series data, linear interpolation can provide more realistic estimates than simple forward/backward filling:</p>
<div id="da3b42e5" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>df_interp <span class="op">=</span> df_missing.copy()</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>df_interp[<span class="st">'price'</span>] <span class="op">=</span> df_interp[<span class="st">'price'</span>].interpolate(method<span class="op">=</span><span class="st">'linear'</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>df_interp[<span class="st">'volume'</span>] <span class="op">=</span> df_interp[<span class="st">'volume'</span>].interpolate(method<span class="op">=</span><span class="st">'linear'</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>df_interp</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.00</td>
<td>1000000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.50</td>
<td>1100000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>152.75</td>
<td>1200000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.00</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.00</td>
<td>1025000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>158.00</td>
<td>1100000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-07</td>
<td>AAPL</td>
<td>159.00</td>
<td>1300000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-08</td>
<td>AAPL</td>
<td>158.50</td>
<td>1275000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-09</td>
<td>AAPL</td>
<td>159.75</td>
<td>1250000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-10</td>
<td>AAPL</td>
<td>161.00</td>
<td>1400000.0</td>
<td>0.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Time-based interpolation accounts for irregular spacing and requires a DatetimeIndex:</p>
<div id="e6afe360" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_interp_time <span class="op">=</span> df_missing.copy().set_index(<span class="st">'date'</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>df_interp_time[<span class="st">'price'</span>] <span class="op">=</span> df_interp_time[<span class="st">'price'</span>].interpolate(method<span class="op">=</span><span class="st">'time'</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>df_interp_time <span class="op">=</span> df_interp_time.reset_index()</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>df_interp_time</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">dividend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.00</td>
<td>1000000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.50</td>
<td>NaN</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>152.75</td>
<td>1200000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.00</td>
<td>950000.0</td>
<td>0.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.00</td>
<td>NaN</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>158.00</td>
<td>1100000.0</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-07</td>
<td>AAPL</td>
<td>159.00</td>
<td>1300000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-08</td>
<td>AAPL</td>
<td>158.50</td>
<td>NaN</td>
<td>0.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-09</td>
<td>AAPL</td>
<td>159.75</td>
<td>1250000.0</td>
<td>0.00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-10</td>
<td>AAPL</td>
<td>161.00</td>
<td>1400000.0</td>
<td>0.00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="group-based-imputation" class="level4" data-number="13.2.4.3">
<h4 data-number="13.2.4.3" class="anchored" data-anchor-id="group-based-imputation"><span class="header-section-number">13.2.4.3</span> Group-based imputation</h4>
<p>Often, you want to impute missing values differently for different groups. For example, you might want to impute missing returns for each industry separately:</p>
<div id="a65e3cb9" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data with multiple tickers</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>data_grouped <span class="op">=</span> {</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'date'</span>: pd.date_range(<span class="st">'2024-01-01'</span>, periods<span class="op">=</span><span class="dv">6</span>, freq<span class="op">=</span><span class="st">'D'</span>).tolist() <span class="op">*</span> <span class="dv">2</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>] <span class="op">*</span> <span class="dv">6</span> <span class="op">+</span> [<span class="st">'MSFT'</span>] <span class="op">*</span> <span class="dv">6</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'price'</span>: [<span class="fl">150.0</span>, np.nan, <span class="fl">155.0</span>, <span class="fl">153.0</span>, np.nan, <span class="fl">161.0</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>              <span class="fl">250.0</span>, <span class="fl">252.0</span>, np.nan, <span class="fl">258.0</span>, <span class="fl">260.0</span>, np.nan],</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sector'</span>: [<span class="st">'Tech'</span>] <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>df_grouped <span class="op">=</span> pd.DataFrame(data_grouped)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>df_grouped</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">sector</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>NaN</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.0</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.0</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>NaN</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>161.0</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-01</td>
<td>MSFT</td>
<td>250.0</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-02</td>
<td>MSFT</td>
<td>252.0</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-03</td>
<td>MSFT</td>
<td>NaN</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-04</td>
<td>MSFT</td>
<td>258.0</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>2024-01-05</td>
<td>MSFT</td>
<td>260.0</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>2024-01-06</td>
<td>MSFT</td>
<td>NaN</td>
<td>Tech</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Forward fill within each ticker group:</p>
<div id="2330b58f" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>df_grouped_ffill <span class="op">=</span> df_grouped.copy()</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>df_grouped_ffill[<span class="st">'price'</span>] <span class="op">=</span> df_grouped_ffill.groupby(<span class="st">'ticker'</span>)[<span class="st">'price'</span>].ffill()</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>df_grouped_ffill</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">sector</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>150.0</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.0</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.0</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>153.0</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>161.0</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-01</td>
<td>MSFT</td>
<td>250.0</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-02</td>
<td>MSFT</td>
<td>252.0</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-03</td>
<td>MSFT</td>
<td>252.0</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-04</td>
<td>MSFT</td>
<td>258.0</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>2024-01-05</td>
<td>MSFT</td>
<td>260.0</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>2024-01-06</td>
<td>MSFT</td>
<td>260.0</td>
<td>Tech</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Mean imputation within each sector:</p>
<div id="37ada4c5" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>df_grouped_mean <span class="op">=</span> df_grouped.copy()</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>df_grouped_mean[<span class="st">'price'</span>] <span class="op">=</span> df_grouped_mean.groupby(<span class="st">'sector'</span>)[<span class="st">'price'</span>].transform(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: x.fillna(x.mean())</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>df_grouped_mean</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">sector</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.000</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>204.875</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.000</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>153.000</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>204.875</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-01-06</td>
<td>AAPL</td>
<td>161.000</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>2024-01-01</td>
<td>MSFT</td>
<td>250.000</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2024-01-02</td>
<td>MSFT</td>
<td>252.000</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>2024-01-03</td>
<td>MSFT</td>
<td>204.875</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2024-01-04</td>
<td>MSFT</td>
<td>258.000</td>
<td>Tech</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>2024-01-05</td>
<td>MSFT</td>
<td>260.000</td>
<td>Tech</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>2024-01-06</td>
<td>MSFT</td>
<td>204.875</td>
<td>Tech</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In Polars, we use the <code>over()</code> method for group-based operations:</p>
<div id="ab32ba26" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df_grouped_pl <span class="op">=</span> pl.from_pandas(df_grouped)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward fill within groups</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>df_grouped_ffill_pl <span class="op">=</span> df_grouped_pl.with_columns([</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'price'</span>).forward_fill().over(<span class="st">'ticker'</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>df_grouped_ffill_pl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (12, 4)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">sector</th>
</tr>
<tr class="even">
<td>datetime[ns]</td>
<td>str</td>
<td>f64</td>
<td>str</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-01 00:00:00</td>
<td>"AAPL"</td>
<td>150.0</td>
<td>"Tech"</td>
</tr>
<tr class="even">
<td>2024-01-02 00:00:00</td>
<td>"AAPL"</td>
<td>150.0</td>
<td>"Tech"</td>
</tr>
<tr class="odd">
<td>2024-01-03 00:00:00</td>
<td>"AAPL"</td>
<td>155.0</td>
<td>"Tech"</td>
</tr>
<tr class="even">
<td>2024-01-04 00:00:00</td>
<td>"AAPL"</td>
<td>153.0</td>
<td>"Tech"</td>
</tr>
<tr class="odd">
<td>2024-01-05 00:00:00</td>
<td>"AAPL"</td>
<td>153.0</td>
<td>"Tech"</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>2024-01-02 00:00:00</td>
<td>"MSFT"</td>
<td>252.0</td>
<td>"Tech"</td>
</tr>
<tr class="even">
<td>2024-01-03 00:00:00</td>
<td>"MSFT"</td>
<td>252.0</td>
<td>"Tech"</td>
</tr>
<tr class="odd">
<td>2024-01-04 00:00:00</td>
<td>"MSFT"</td>
<td>258.0</td>
<td>"Tech"</td>
</tr>
<tr class="even">
<td>2024-01-05 00:00:00</td>
<td>"MSFT"</td>
<td>260.0</td>
<td>"Tech"</td>
</tr>
<tr class="odd">
<td>2024-01-06 00:00:00</td>
<td>"MSFT"</td>
<td>260.0</td>
<td>"Tech"</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="4c258e66" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean imputation within groups</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>df_grouped_mean_pl <span class="op">=</span> df_grouped_pl.with_columns([</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'price'</span>).fill_null(pl.col(<span class="st">'price'</span>).mean()).over(<span class="st">'sector'</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>df_grouped_mean_pl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (12, 4)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">sector</th>
</tr>
<tr class="even">
<td>datetime[ns]</td>
<td>str</td>
<td>f64</td>
<td>str</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-01 00:00:00</td>
<td>"AAPL"</td>
<td>150.0</td>
<td>"Tech"</td>
</tr>
<tr class="even">
<td>2024-01-02 00:00:00</td>
<td>"AAPL"</td>
<td>204.875</td>
<td>"Tech"</td>
</tr>
<tr class="odd">
<td>2024-01-03 00:00:00</td>
<td>"AAPL"</td>
<td>155.0</td>
<td>"Tech"</td>
</tr>
<tr class="even">
<td>2024-01-04 00:00:00</td>
<td>"AAPL"</td>
<td>153.0</td>
<td>"Tech"</td>
</tr>
<tr class="odd">
<td>2024-01-05 00:00:00</td>
<td>"AAPL"</td>
<td>204.875</td>
<td>"Tech"</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>2024-01-02 00:00:00</td>
<td>"MSFT"</td>
<td>252.0</td>
<td>"Tech"</td>
</tr>
<tr class="even">
<td>2024-01-03 00:00:00</td>
<td>"MSFT"</td>
<td>204.875</td>
<td>"Tech"</td>
</tr>
<tr class="odd">
<td>2024-01-04 00:00:00</td>
<td>"MSFT"</td>
<td>258.0</td>
<td>"Tech"</td>
</tr>
<tr class="even">
<td>2024-01-05 00:00:00</td>
<td>"MSFT"</td>
<td>260.0</td>
<td>"Tech"</td>
</tr>
<tr class="odd">
<td>2024-01-06 00:00:00</td>
<td>"MSFT"</td>
<td>204.875</td>
<td>"Tech"</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="data-validation" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="data-validation"><span class="header-section-number">13.3</span> Data Validation</h2>
<p>Data validation is the process of checking whether your data meets quality standards and assumptions before analysis. In finance, invalid data can lead to catastrophic errors—imagine executing a trading strategy based on incorrect prices or publishing research with flawed data.</p>
<p>Validation encompasses several activities:</p>
<ul>
<li>Checking data types and formats</li>
<li>Verifying data ranges and constraints</li>
<li>Identifying outliers and anomalies</li>
<li>Ensuring logical consistency</li>
<li>Cross-checking against external sources</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Automated validation with pandera
</div>
</div>
<div class="callout-body-container callout-body">
<p>For systematic data validation, consider using <a href="https://pandera.readthedocs.io/en/stable/index.html">pandera</a>, a Python framework for automatic validation of DataFrames. Pandera lets you define schemas that specify expected data types, value ranges, and other constraints, then automatically validates your data against these schemas. It supports both pandas and Polars.</p>
</div>
</div>
<section id="validating-data-types-and-formats" class="level3" data-number="13.3.1">
<h3 data-number="13.3.1" class="anchored" data-anchor-id="validating-data-types-and-formats"><span class="header-section-number">13.3.1</span> Validating data types and formats</h3>
<p>First, ensure that each column has the correct data type:</p>
<div id="946bfd3b" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sample data with type issues</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>data_types <span class="op">=</span> {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'date'</span>: [<span class="st">'2024-01-01'</span>, <span class="st">'2024-01-02'</span>, <span class="st">'2024-01-03'</span>, <span class="st">'invalid'</span>],</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>, <span class="st">'AAPL'</span>, <span class="st">'AAPL'</span>, <span class="st">'AAPL'</span>],</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'price'</span>: [<span class="st">'150.0'</span>, <span class="st">'152.5'</span>, <span class="st">'155.0'</span>, <span class="st">'153.0'</span>],  <span class="co"># Stored as strings</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'volume'</span>: [<span class="dv">1000000</span>, <span class="dv">1100000</span>, <span class="dv">1200000</span>, <span class="op">-</span><span class="dv">950000</span>]  <span class="co"># Negative volume</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>df_types <span class="op">=</span> pd.DataFrame(data_types)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>df_types</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.5</td>
<td>1100000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.0</td>
<td>1200000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>invalid</td>
<td>AAPL</td>
<td>153.0</td>
<td>-950000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="b6c2b4a5" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df_types.dtypes</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>date      object
ticker    object
price     object
volume     int64
dtype: object</code></pre>
</div>
</div>
<p>Now let’s validate and fix the types. We use <code>errors='coerce'</code> to convert invalid values to <code>NaN</code> instead of raising an error:</p>
<div id="f8a63663" class="cell" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert price to numeric, coercing errors to NaN</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>df_types[<span class="st">'price'</span>] <span class="op">=</span> pd.to_numeric(df_types[<span class="st">'price'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert date to datetime</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>df_types[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(df_types[<span class="st">'date'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>df_types</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>152.5</td>
<td>1100000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.0</td>
<td>1200000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>NaT</td>
<td>AAPL</td>
<td>153.0</td>
<td>-950000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="da0fef2b" class="cell" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>df_types.dtypes</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>date      datetime64[ns]
ticker            object
price            float64
volume             int64
dtype: object</code></pre>
</div>
</div>
<p>We can identify rows with conversion errors by checking for <code>NaN</code> values:</p>
<div id="d07e6e9b" class="cell" data-execution_count="43">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>invalid_dates <span class="op">=</span> df_types[<span class="st">'date'</span>].isna()</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rows with invalid dates: </span><span class="sc">{</span>invalid_dates<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows with invalid dates: 1</code></pre>
</div>
</div>
<div id="817aa5bb" class="cell" data-execution_count="44">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>df_types[invalid_dates]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">3</th>
<td>NaT</td>
<td>AAPL</td>
<td>153.0</td>
<td>-950000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Common type issues in financial data
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Dates</strong>: Mixed formats (MM/DD/YYYY vs DD/MM/YYYY), Excel date serials, timezone issues</li>
<li><strong>Numbers</strong>: Thousands separators, currency symbols, percentage signs stored as text</li>
<li><strong>Missing values</strong>: Coded as -999, ‘NA’, empty strings, or other sentinel values</li>
<li><strong>Categorical variables</strong>: Inconsistent capitalization or spelling</li>
</ul>
<p>Always check types early in your pipeline and convert them explicitly.</p>
</div>
</div>
</section>
<section id="range-and-constraint-validation" class="level3" data-number="13.3.2">
<h3 data-number="13.3.2" class="anchored" data-anchor-id="range-and-constraint-validation"><span class="header-section-number">13.3.2</span> Range and constraint validation</h3>
<p>Financial data often has natural constraints. Prices must be positive, probabilities must be between 0 and 1, and returns are typically bounded (though extreme events can violate typical ranges).</p>
<div id="6397ef01" class="cell" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data with constraint violations</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>data_constraints <span class="op">=</span> {</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'date'</span>: pd.date_range(<span class="st">'2024-01-01'</span>, periods<span class="op">=</span><span class="dv">5</span>, freq<span class="op">=</span><span class="st">'D'</span>),</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ticker'</span>: [<span class="st">'AAPL'</span>] <span class="op">*</span> <span class="dv">5</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'price'</span>: [<span class="fl">150.0</span>, <span class="op">-</span><span class="fl">152.5</span>, <span class="fl">155.0</span>, <span class="fl">1000000.0</span>, <span class="fl">157.0</span>],  <span class="co"># Negative and extreme prices</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'volume'</span>: [<span class="dv">1000000</span>, <span class="dv">1100000</span>, <span class="dv">1200000</span>, <span class="op">-</span><span class="dv">950000</span>, <span class="dv">1300000</span>],  <span class="co"># Negative volume</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'return'</span>: [<span class="fl">0.01</span>, <span class="fl">0.02</span>, <span class="op">-</span><span class="fl">0.01</span>, <span class="fl">5.0</span>, <span class="op">-</span><span class="fl">0.03</span>]  <span class="co"># Extreme return</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>df_constraints <span class="op">=</span> pd.DataFrame(data_constraints)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Define validation rules</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_price(price):</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Check if price is valid."""</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (price <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (price <span class="op">&lt;</span> <span class="dv">100000</span>)</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_volume(volume):</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Check if volume is valid."""</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> volume <span class="op">&gt;=</span> <span class="dv">0</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_return(ret):</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Check if return is reasonable."""</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (ret <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span>) <span class="op">&amp;</span> (ret <span class="op">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply validation</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>df_constraints[<span class="st">'price_valid'</span>] <span class="op">=</span> validate_price(df_constraints[<span class="st">'price'</span>])</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>df_constraints[<span class="st">'volume_valid'</span>] <span class="op">=</span> validate_volume(df_constraints[<span class="st">'volume'</span>])</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>df_constraints[<span class="st">'return_valid'</span>] <span class="op">=</span> validate_return(df_constraints[<span class="st">'return'</span>])</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>df_constraints</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">price_valid</th>
<th data-quarto-table-cell-role="th">volume_valid</th>
<th data-quarto-table-cell-role="th">return_valid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01-01</td>
<td>AAPL</td>
<td>150.0</td>
<td>1000000</td>
<td>0.01</td>
<td>True</td>
<td>True</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>-152.5</td>
<td>1100000</td>
<td>0.02</td>
<td>False</td>
<td>True</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-01-03</td>
<td>AAPL</td>
<td>155.0</td>
<td>1200000</td>
<td>-0.01</td>
<td>True</td>
<td>True</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>1000000.0</td>
<td>-950000</td>
<td>5.00</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-01-05</td>
<td>AAPL</td>
<td>157.0</td>
<td>1300000</td>
<td>-0.03</td>
<td>True</td>
<td>True</td>
<td>True</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can identify invalid rows by combining the validation columns:</p>
<div id="5386e9d9" class="cell" data-execution_count="46">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>invalid_mask <span class="op">=</span> <span class="op">~</span>(df_constraints[<span class="st">'price_valid'</span>] <span class="op">&amp;</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>                 df_constraints[<span class="st">'volume_valid'</span>] <span class="op">&amp;</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                 df_constraints[<span class="st">'return_valid'</span>])</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Invalid rows: </span><span class="sc">{</span>invalid_mask<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Invalid rows: 2</code></pre>
</div>
</div>
<div id="a5de4bbf" class="cell" data-execution_count="47">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>df_constraints[invalid_mask]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">price_valid</th>
<th data-quarto-table-cell-role="th">volume_valid</th>
<th data-quarto-table-cell-role="th">return_valid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-01-02</td>
<td>AAPL</td>
<td>-152.5</td>
<td>1100000</td>
<td>0.02</td>
<td>False</td>
<td>True</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-01-04</td>
<td>AAPL</td>
<td>1000000.0</td>
<td>-950000</td>
<td>5.00</td>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In Polars, we can use expressions for validation:</p>
<div id="01682f45" class="cell" data-execution_count="48">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>df_constraints_pl <span class="op">=</span> pl.DataFrame(data_constraints)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add validation columns</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>df_validated_pl <span class="op">=</span> df_constraints_pl.with_columns([</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    ((pl.col(<span class="st">'price'</span>) <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (pl.col(<span class="st">'price'</span>) <span class="op">&lt;</span> <span class="dv">100000</span>)).alias(<span class="st">'price_valid'</span>),</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    (pl.col(<span class="st">'volume'</span>) <span class="op">&gt;=</span> <span class="dv">0</span>).alias(<span class="st">'volume_valid'</span>),</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    ((pl.col(<span class="st">'return'</span>) <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span>) <span class="op">&amp;</span> (pl.col(<span class="st">'return'</span>) <span class="op">&lt;</span> <span class="dv">1</span>)).alias(<span class="st">'return_valid'</span>)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>df_validated_pl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (5, 8)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">price_valid</th>
<th data-quarto-table-cell-role="th">volume_valid</th>
<th data-quarto-table-cell-role="th">return_valid</th>
</tr>
<tr class="even">
<td>datetime[ns]</td>
<td>str</td>
<td>f64</td>
<td>i64</td>
<td>f64</td>
<td>bool</td>
<td>bool</td>
<td>bool</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-01 00:00:00</td>
<td>"AAPL"</td>
<td>150.0</td>
<td>1000000</td>
<td>0.01</td>
<td>true</td>
<td>true</td>
<td>true</td>
</tr>
<tr class="even">
<td>2024-01-02 00:00:00</td>
<td>"AAPL"</td>
<td>-152.5</td>
<td>1100000</td>
<td>0.02</td>
<td>false</td>
<td>true</td>
<td>true</td>
</tr>
<tr class="odd">
<td>2024-01-03 00:00:00</td>
<td>"AAPL"</td>
<td>155.0</td>
<td>1200000</td>
<td>-0.01</td>
<td>true</td>
<td>true</td>
<td>true</td>
</tr>
<tr class="even">
<td>2024-01-04 00:00:00</td>
<td>"AAPL"</td>
<td>1e6</td>
<td>-950000</td>
<td>5.0</td>
<td>false</td>
<td>false</td>
<td>false</td>
</tr>
<tr class="odd">
<td>2024-01-05 00:00:00</td>
<td>"AAPL"</td>
<td>157.0</td>
<td>1300000</td>
<td>-0.03</td>
<td>true</td>
<td>true</td>
<td>true</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="12f29d57" class="cell" data-execution_count="49">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to invalid rows</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>invalid_pl <span class="op">=</span> df_validated_pl.<span class="bu">filter</span>(</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">~</span>pl.col(<span class="st">'price_valid'</span>) <span class="op">|</span> <span class="op">~</span>pl.col(<span class="st">'volume_valid'</span>) <span class="op">|</span> <span class="op">~</span>pl.col(<span class="st">'return_valid'</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>invalid_pl</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<div><style>
.dataframe > thead > tr,
.dataframe > tbody > tr {
  text-align: right;
  white-space: pre-wrap;
}
</style>
<small>shape: (2, 8)</small>
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">price</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">return</th>
<th data-quarto-table-cell-role="th">price_valid</th>
<th data-quarto-table-cell-role="th">volume_valid</th>
<th data-quarto-table-cell-role="th">return_valid</th>
</tr>
<tr class="even">
<td>datetime[ns]</td>
<td>str</td>
<td>f64</td>
<td>i64</td>
<td>f64</td>
<td>bool</td>
<td>bool</td>
<td>bool</td>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024-01-02 00:00:00</td>
<td>"AAPL"</td>
<td>-152.5</td>
<td>1100000</td>
<td>0.02</td>
<td>false</td>
<td>true</td>
<td>true</td>
</tr>
<tr class="even">
<td>2024-01-04 00:00:00</td>
<td>"AAPL"</td>
<td>1e6</td>
<td>-950000</td>
<td>5.0</td>
<td>false</td>
<td>false</td>
<td>false</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="detecting-outliers" class="level3" data-number="13.3.3">
<h3 data-number="13.3.3" class="anchored" data-anchor-id="detecting-outliers"><span class="header-section-number">13.3.3</span> Detecting outliers</h3>
<p>Outliers are observations that deviate significantly from other observations. In finance, outliers could indicate:</p>
<ul>
<li>Genuine extreme events (market crashes, flash crashes)</li>
<li>Data errors (wrong decimal place, data feed glitches)</li>
<li>Special situations (stock splits, spinoffs)</li>
</ul>
<p>Outlier detection requires domain knowledge. A 50% daily return is an error for a typical stock but normal for a penny stock or during a takeover announcement.</p>
<section id="statistical-methods-for-outlier-detection" class="level4" data-number="13.3.3.1">
<h4 data-number="13.3.3.1" class="anchored" data-anchor-id="statistical-methods-for-outlier-detection"><span class="header-section-number">13.3.3.1</span> Statistical methods for outlier detection</h4>
<p>Common approaches include:</p>
<ol type="1">
<li><strong>Z-score method</strong>: Flag observations more than N standard deviations from the mean</li>
<li><strong>IQR method</strong>: Flag observations outside 1.5 times the interquartile range</li>
<li><strong>Modified Z-score</strong>: Use median absolute deviation instead of standard deviation (more robust)</li>
<li><strong>Domain-specific rules</strong>: Use knowledge about reasonable ranges</li>
</ol>
<p>Choosing the right method for a particular application is beyond the scope of this book and requires careful consideration of the data characteristics and analysis goals.</p>
</section>
<section id="handling-outliers" class="level4" data-number="13.3.3.2">
<h4 data-number="13.3.3.2" class="anchored" data-anchor-id="handling-outliers"><span class="header-section-number">13.3.3.2</span> Handling outliers</h4>
<p>Once you’ve identified outliers, you have several options:</p>
<ol type="1">
<li><strong>Keep them</strong>: If they’re genuine extreme events</li>
<li><strong>Remove them</strong>: If they’re clearly errors</li>
<li><strong>Cap/Winsorize</strong>: Replace extreme values with a threshold</li>
<li><strong>Transform the data</strong>: Use log transformation or other methods to reduce the impact</li>
<li><strong>Investigate</strong>: Manually check each outlier</li>
</ol>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Be cautious with outlier removal
</div>
</div>
<div class="callout-body-container callout-body">
<p>In finance, extreme events are often the most important observations. The 2008 financial crisis, COVID-19 market crash, and other tail events are “outliers” but carry critical information. Before removing outliers:</p>
<ol type="1">
<li>Investigate each one individually if possible</li>
<li>Check if they coincide with known events (earnings announcements, news, market crises)</li>
<li>Consider the impact on your conclusions if you keep vs.&nbsp;remove them</li>
<li>Document your decision and reasoning</li>
</ol>
<p>When in doubt, perform your analysis both with and without outliers to assess sensitivity.</p>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../data-analysis/io/index.html" class="pagination-link" aria-label="Data Input and File Formats">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Data Input and File Formats</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../data-analysis/structuring/index.html" class="pagination-link" aria-label="Data Structuring and Aggregation">
        <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Data Structuring and Aggregation</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://vincentgregoire.com">
<p>© 2026 Vincent Grégoire</p>
</a>
  </li>  
    <li class="nav-item">
  - 
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
<p>Licensed under CC BY-NC-ND 4.0</p>
</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>